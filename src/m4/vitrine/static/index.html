<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>vitrine</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=DM+Mono:wght@400;500&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  /* ================================================================
     THEME VARIABLES & RESET
     ================================================================ */
  :root {
    --bg: #ffffff;
    --bg-card: #f8f9fa;
    --bg-header: #f0f1f3;
    --text: #1a1a2e;
    --text-muted: #6c757d;
    --border: #dee2e6;
    --accent: #4361ee;
    --accent-hover: #3a56d4;
    --success: #2ec4b6;
    --error: #e63946;
    --warning: #ffc107;
    --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
    --mono: 'SF Mono', 'Fira Code', 'Fira Mono', Menlo, Consolas, monospace;
    --radius: 8px;
    --shadow: 0 1px 3px rgba(0,0,0,0.08);
    --pin-color: #f59e0b;
  }

  [data-theme="dark"] {
    --bg: #1a1b26;
    --bg-card: #24253a;
    --bg-header: #1e1f32;
    --text: #c0caf5;
    --text-muted: #7982a9;
    --border: #33354a;
    --accent: #7aa2f7;
    --accent-hover: #89b4fa;
    --success: #9ece6a;
    --error: #f7768e;
    --warning: #e0af68;
    --shadow: 0 1px 3px rgba(0,0,0,0.3);
    --pin-color: #e0af68;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    transition: background 0.2s, color 0.2s;
  }

  /* ================================================================
     LAYOUT & HEADER
     ================================================================ */
  .header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    padding: 10px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: background 0.2s, border-color 0.2s;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .header h1 {
    font-size: 15px;
    font-weight: 600;
    letter-spacing: -0.3px;
  }

  /* ================================================================
     RUN MANAGEMENT — dropdown, metadata bar, separators, rename
     ================================================================ */
  .run-dropdown {
    position: relative;
    display: inline-block;
  }

  .run-dropdown-trigger {
    padding: 5px 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg);
    color: var(--text);
    font-size: 12px;
    font-family: var(--font);
    cursor: pointer;
    outline: none;
    transition: border-color 0.15s, background 0.15s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .run-dropdown-trigger:hover { border-color: var(--accent); }
  .run-dropdown-trigger.open { border-color: var(--accent); background: var(--bg-card); }

  .run-dropdown-trigger .dd-arrow {
    font-size: 10px;
    color: var(--text-muted);
    transition: transform 0.15s;
  }

  .run-dropdown-trigger.open .dd-arrow { transform: rotate(180deg); }

  .run-dropdown-panel {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    z-index: 110;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    min-width: 300px;
    max-width: 380px;
    max-height: 420px;
    overflow-y: auto;
    animation: fadeIn 0.15s ease;
  }

  .run-dropdown-all {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.15s;
    border-bottom: 1px solid var(--border);
  }

  .run-dropdown-all:hover { background: var(--bg-header); }
  .run-dropdown-all.selected { font-weight: 600; color: var(--accent); }

  .run-dropdown-group-label {
    padding: 8px 12px 4px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
  }

  .run-dropdown-entry {
    padding: 6px 12px;
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.15s;
  }

  .run-dropdown-entry:hover { background: var(--bg-header); }
  .run-dropdown-entry.selected { background: var(--bg-card); }

  .run-dropdown-empty {
    padding: 16px 12px;
    font-size: 12px;
    color: var(--text-muted);
    text-align: center;
  }

  .run-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .run-dot.active { background: var(--success); }
  .run-dot.inactive { background: transparent; border: 1px solid var(--border); }

  .run-entry-label {
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .run-entry-meta {
    color: var(--text-muted);
    font-size: 11px;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .run-delete-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-muted);
    font-size: 14px;
    padding: 0 2px;
    line-height: 1;
    opacity: 0;
    transition: opacity 0.15s, color 0.15s;
    flex-shrink: 0;
  }

  .run-dropdown-entry:hover .run-delete-btn { opacity: 1; }
  .run-delete-btn:hover { color: var(--error); }

  /* Confirm modal */
  .confirm-overlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: rgba(0,0,0,0.45);
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.12s ease;
  }
  .confirm-dialog {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: 0 8px 32px rgba(0,0,0,0.25);
    padding: 20px 24px;
    min-width: 320px;
    max-width: 400px;
    font-family: var(--font);
  }
  .confirm-dialog h3 {
    margin: 0 0 8px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
  }
  .confirm-dialog p {
    margin: 0 0 18px;
    font-size: 13px;
    color: var(--text-muted);
    line-height: 1.4;
  }
  .confirm-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
  }
  .confirm-actions button {
    padding: 6px 14px;
    border-radius: 5px;
    font-size: 12px;
    font-family: var(--font);
    cursor: pointer;
    border: 1px solid var(--border);
    transition: background 0.15s, border-color 0.15s;
  }
  .confirm-cancel {
    background: var(--bg);
    color: var(--text);
  }
  .confirm-cancel:hover { background: var(--bg-header); }
  .confirm-danger {
    background: var(--error);
    color: #fff;
    border-color: var(--error);
  }
  .confirm-danger:hover { opacity: 0.85; }

  /* Inline run name editing (metadata bar) */
  .run-meta-label {
    cursor: text;
  }
  .run-meta-label:hover {
    text-decoration: underline;
    text-decoration-style: dashed;
    text-underline-offset: 3px;
    text-decoration-color: var(--text-muted);
  }
  .run-meta-edit-wrap {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    position: relative;
  }
  .run-meta-edit-input {
    font-size: 13px;
    font-weight: 600;
    font-family: var(--font);
    padding: 2px 6px;
    border: 1px solid var(--accent);
    border-radius: 4px;
    background: var(--bg);
    color: var(--text);
    outline: none;
    min-width: 160px;
  }
  .run-meta-edit-input.invalid {
    border-color: var(--error);
  }
  .run-meta-edit-hint {
    font-size: 11px;
    color: var(--error);
    white-space: nowrap;
  }

  /* Run metadata bar */
  .run-metadata-bar {
    max-width: 960px;
    margin: 0 auto;
    padding: 12px 24px 0;
    display: none;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: var(--text-muted);
  }

  .run-metadata-bar.visible { display: flex; }

  .run-meta-label {
    font-weight: 600;
    color: var(--text);
  }

  .run-meta-sep {
    color: var(--border);
  }

  /* Run separator in feed (All runs view) */
  .run-separator {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 0 4px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-muted);
  }

  .run-separator::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .run-separator.hidden-by-filter { display: none; }

  /* ================================================================
     EXPORT DROPDOWN
     ================================================================ */
  .export-dropdown {
    position: relative;
    display: inline-block;
  }

  .export-dropdown-panel {
    position: absolute;
    top: calc(100% + 4px);
    right: 0;
    z-index: 110;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    min-width: 180px;
    animation: fadeIn 0.15s ease;
  }

  .export-dropdown-item {
    padding: 8px 14px;
    cursor: pointer;
    font-size: 12px;
    font-family: var(--font);
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.15s;
    border: none;
    background: none;
    color: var(--text);
    width: 100%;
    text-align: left;
  }

  .export-dropdown-item:hover { background: var(--bg-header); }

  .export-dropdown-item .export-icon {
    font-size: 13px;
    opacity: 0.6;
    width: 18px;
    text-align: center;
  }

  .export-dropdown-sep {
    height: 1px;
    background: var(--border);
    margin: 2px 0;
  }

  /* Run dropdown export button */
  .run-export-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-muted);
    font-size: 12px;
    padding: 0 2px;
    line-height: 1;
    opacity: 0;
    transition: opacity 0.15s, color 0.15s;
    flex-shrink: 0;
  }

  .run-dropdown-entry:hover .run-export-btn { opacity: 1; }
  .run-export-btn:hover { color: var(--accent); }

  .header-actions {
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .btn {
    padding: 5px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg);
    color: var(--text);
    font-size: 12px;
    cursor: pointer;
    font-family: var(--font);
    transition: background 0.15s, border-color 0.15s, color 0.15s;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .btn:hover { background: var(--bg-header); }

  .btn-icon {
    padding: 5px 8px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    border-radius: 4px;
    font-size: 14px;
    line-height: 1;
    transition: color 0.15s, background 0.15s;
  }

  .btn-icon:hover {
    color: var(--text);
    background: var(--bg-header);
  }

  /* ================================================================
     CARD FEED & BASE CARD STYLES
     ================================================================ */
  .feed {
    max-width: 960px;
    margin: 0 auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    min-height: calc(100vh - 110px);
  }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    color: var(--text-muted);
    gap: 8px;
    padding: 80px 0;
  }

  .empty-state code {
    font-family: var(--mono);
    background: var(--bg-card);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 13px;
  }

  /* Cards */
  .card {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--bg);
    box-shadow: var(--shadow);
    overflow: hidden;
    animation: fadeIn 0.2s ease;
    transition: border-color 0.15s, box-shadow 0.15s, background 0.2s;
  }

  .card.pinned {
    border-color: var(--pin-color);
    box-shadow: 0 0 0 1px var(--pin-color), var(--shadow);
  }

  .card.hidden-by-filter { display: none; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .card-header {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    background: var(--bg-header);
    border-bottom: 1px solid var(--border);
    font-size: 13px;
    gap: 8px;
    user-select: none;
    transition: background 0.2s, border-color 0.2s;
  }

  .card-collapse-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-muted);
    font-size: 10px;
    padding: 2px;
    line-height: 1;
    transition: transform 0.15s, color 0.15s;
    flex-shrink: 0;
  }

  .card-collapse-btn:hover { color: var(--text); }
  .card-collapse-btn.collapsed { transform: rotate(-90deg); }

  .card-title {
    font-weight: 600;
    font-size: 13px;
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .card-actions {
    display: flex;
    gap: 2px;
    align-items: center;
    flex-shrink: 0;
  }

  .card-action-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-muted);
    font-size: 13px;
    padding: 3px 5px;
    border-radius: 3px;
    line-height: 1;
    transition: color 0.15s, background 0.15s;
  }

  .card-action-btn:hover {
    color: var(--text);
    background: var(--bg-card);
  }

  .card-action-btn.pinned { color: var(--pin-color); }
  .card-action-btn.copied { color: var(--success); }

  .card-meta {
    color: var(--text-muted);
    font-size: 11px;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .card-body {
    padding: 16px;
    transition: background 0.2s;
  }

  .card-body.collapsed {
    display: none;
  }

  .card-provenance {
    padding: 6px 12px;
    border-top: 1px solid var(--border);
    font-size: 11px;
    color: var(--text-muted);
    font-family: var(--mono);
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    transition: border-color 0.2s;
  }

  .card-provenance.collapsed {
    display: none;
  }

  /* ================================================================
     CARD TYPE STYLES — table, markdown, key-value, plotly, image
     ================================================================ */

  /* Table cards */
  .table-wrapper {
    overflow-x: auto;
    overflow-y: auto;
    max-height: 360px;
    font-size: 13px;
  }

  .table-wrapper table {
    width: 100%;
    border-collapse: collapse;
    font-family: var(--mono);
    font-size: 12px;
  }

  .table-wrapper th {
    text-align: left;
    padding: 7px 12px;
    border-bottom: 2px solid var(--border);
    font-weight: 600;
    white-space: nowrap;
    background: var(--bg-card);
    position: sticky;
    top: 0;
    z-index: 1;
    cursor: pointer;
    user-select: none;
    transition: background 0.15s;
  }

  .table-wrapper th:hover {
    background: var(--bg-header);
  }

  .table-wrapper th .sort-indicator {
    display: inline-block;
    margin-left: 4px;
    font-size: 10px;
    color: var(--text-muted);
    opacity: 0;
    transition: opacity 0.15s;
  }

  .table-wrapper th:hover .sort-indicator { opacity: 0.5; }
  .table-wrapper th .sort-indicator.active { opacity: 1; color: var(--accent); }

  .table-wrapper td {
    padding: 5px 12px;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .table-wrapper tr:hover td {
    background: var(--bg-card);
  }

  .table-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    font-size: 12px;
    color: var(--text-muted);
  }

  .table-pager {
    display: flex;
    gap: 4px;
    align-items: center;
  }

  .table-pager button {
    padding: 3px 10px;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: var(--bg);
    color: var(--text);
    cursor: pointer;
    font-size: 12px;
    font-family: var(--font);
    transition: background 0.15s;
  }

  .table-pager button:hover { background: var(--bg-header); }
  .table-pager button:disabled { opacity: 0.4; cursor: default; }

  /* Markdown cards */
  .markdown-body {
    font-size: 14px;
    line-height: 1.7;
  }

  .markdown-body h1, .markdown-body h2, .markdown-body h3 {
    margin: 16px 0 8px;
    font-weight: 600;
  }

  .markdown-body h1 { font-size: 20px; }
  .markdown-body h2 { font-size: 17px; }
  .markdown-body h3 { font-size: 15px; }
  .markdown-body p { margin: 8px 0; }
  .markdown-body strong { font-weight: 600; }

  .markdown-body code {
    font-family: var(--mono);
    background: var(--bg-card);
    padding: 1px 5px;
    border-radius: 3px;
    font-size: 13px;
  }

  .markdown-body pre {
    background: var(--bg-card);
    padding: 12px 16px;
    border-radius: 6px;
    overflow-x: auto;
    margin: 8px 0;
  }

  .markdown-body pre code {
    background: none;
    padding: 0;
  }

  .markdown-body ul, .markdown-body ol {
    padding-left: 24px;
    margin: 8px 0;
  }

  /* Key-value cards */
  .kv-list {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 4px 16px;
    font-size: 13px;
  }

  .kv-key {
    font-weight: 600;
    color: var(--text-muted);
    text-align: right;
    font-family: var(--mono);
  }

  .kv-value {
    font-family: var(--mono);
  }

  /* Section dividers */
  .section-divider {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 0;
    color: var(--text-muted);
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .section-divider.hidden-by-filter { display: none; }

  .section-divider::before,
  .section-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* Footer */
  .footer {
    position: sticky;
    bottom: 0;
    background: var(--bg);
    border-top: 1px solid var(--border);
    padding: 6px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 11px;
    color: var(--text-muted);
    transition: background 0.2s, border-color 0.2s;
  }

  .status-dot {
    display: inline-block;
    width: 7px;
    height: 7px;
    border-radius: 50%;
    margin-right: 5px;
  }

  .status-connected { background: var(--success); }
  .status-disconnected { background: var(--error); }
  .status-connecting { background: var(--warning); }

  /* Plotly chart cards */
  .plotly-container {
    width: 100%;
    min-height: 300px;
    position: relative;
  }

  .plotly-container .js-plotly-plot {
    width: 100% !important;
  }

  .chart-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 200px;
    color: var(--text-muted);
    font-size: 13px;
    gap: 8px;
  }

  .chart-loading::before {
    content: '';
    width: 16px;
    height: 16px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Image cards (matplotlib SVG) */
  .image-container {
    text-align: center;
  }

  .image-container img {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
  }

  /* Copy toast */
  .copy-toast {
    position: fixed;
    bottom: 48px;
    left: 50%;
    transform: translateX(-50%) translateY(8px);
    background: var(--text);
    color: var(--bg);
    padding: 6px 16px;
    border-radius: 6px;
    font-size: 12px;
    opacity: 0;
    transition: opacity 0.2s, transform 0.2s;
    pointer-events: none;
    z-index: 200;
  }

  .copy-toast.visible {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* ================================================================
     TABLE TOOLBAR, ROW DETAIL & INTERACTIONS
     ================================================================ */
  .table-toolbar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 0 0;
    margin-bottom: 8px;
  }

  .table-search {
    padding: 5px 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg);
    color: var(--text);
    font-size: 12px;
    font-family: var(--font);
    outline: none;
    flex: 1;
    max-width: 260px;
    transition: border-color 0.15s;
  }

  .table-search:focus { border-color: var(--accent); }

  .table-search::placeholder { color: var(--text-muted); }

  /* Column type badges */
  .type-badge {
    display: inline-block;
    font-size: 9px;
    font-weight: 500;
    padding: 0 4px;
    margin-left: 4px;
    border-radius: 3px;
    background: var(--bg);
    color: var(--text-muted);
    border: 1px solid var(--border);
    font-family: var(--mono);
    vertical-align: middle;
    line-height: 15px;
    letter-spacing: 0.3px;
  }

  /* Export button */
  .export-btn {
    padding: 3px 8px;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: var(--bg);
    color: var(--text-muted);
    cursor: pointer;
    font-size: 11px;
    font-family: var(--font);
    transition: background 0.15s, color 0.15s;
    white-space: nowrap;
  }

  .export-btn:hover {
    background: var(--bg-header);
    color: var(--text);
  }

  /* Row detail panel */
  .row-detail-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.25);
    z-index: 150;
    animation: fadeOverlay 0.15s ease;
  }

  @keyframes fadeOverlay {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .row-detail-panel {
    position: fixed;
    right: 0;
    top: 0;
    bottom: 0;
    width: min(480px, 90vw);
    background: var(--bg);
    border-left: 1px solid var(--border);
    box-shadow: -4px 0 16px rgba(0,0,0,0.12);
    z-index: 151;
    display: flex;
    flex-direction: column;
    animation: slideIn 0.2s ease;
  }

  @keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
  }

  .row-detail-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
    font-weight: 600;
  }

  .row-detail-close {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-muted);
    font-size: 18px;
    line-height: 1;
    padding: 2px 6px;
    border-radius: 4px;
    transition: color 0.15s, background 0.15s;
  }

  .row-detail-close:hover {
    color: var(--text);
    background: var(--bg-header);
  }

  .row-detail-body {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
  }

  .row-detail-body .kv-list {
    grid-template-columns: minmax(80px, auto) 1fr;
    gap: 6px 16px;
  }

  .table-wrapper tr { cursor: pointer; }

  /* ================================================================
     RESPONSE UI & DECISION CARDS
     ================================================================ */
  .card.waiting {
    border-left: 3px solid var(--accent);
  }

  @keyframes subtlePulse {
    0%, 100% { box-shadow: var(--shadow); }
    50% { box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent) 20%, transparent), var(--shadow); }
  }

  .card.waiting { animation: subtlePulse 3s ease-in-out infinite; }

  /* Response UI panel */
  .card-response-ui {
    padding: 12px 16px;
    border-top: 1px solid var(--border);
    background: var(--bg-card);
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .response-prompt {
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
  }

  .response-message-input {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg);
    color: var(--text);
    font-size: 12px;
    font-family: var(--font);
    resize: vertical;
    min-height: 36px;
    max-height: 120px;
    outline: none;
    transition: border-color 0.15s;
  }

  .response-message-input:focus { border-color: var(--accent); }

  .response-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .response-btn {
    padding: 6px 16px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 12px;
    font-family: var(--font);
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s, color 0.15s;
  }

  .response-btn-confirm {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }

  .response-btn-confirm:hover {
    background: var(--accent-hover);
    border-color: var(--accent-hover);
  }

  .response-btn-skip {
    background: var(--bg);
    color: var(--text-muted);
  }

  .response-btn-skip:hover {
    background: var(--bg-header);
    color: var(--text);
  }

  .response-timeout {
    margin-left: auto;
    font-size: 11px;
    color: var(--text-muted);
    font-family: var(--mono);
  }

  /* ================================================================
     FORM FIELDS — dropdown, multiselect, slider, checkbox, etc.
     ================================================================ */
  .form-fields {
    display: flex;
    flex-direction: column;
    gap: 14px;
    padding: 4px 0;
  }

  .form-field {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .form-field-label {
    font-size: 12px;
    font-weight: 500;
    color: var(--text);
  }

  .form-field select,
  .form-field input[type="text"],
  .form-field input[type="number"],
  .form-field input[type="date"],
  .form-select-trigger,
  .form-date-trigger {
    width: 100%;
    padding: 7px 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg);
    color: var(--text);
    font-size: 13px;
    font-family: var(--font);
    outline: none;
    transition: border-color 0.15s;
  }

  .form-field select:focus,
  .form-field input[type="text"]:focus,
  .form-field input[type="number"]:focus,
  .form-field input[type="date"]:focus,
  .form-select-trigger:focus-visible,
  .form-date-trigger:focus-visible {
    border-color: var(--accent);
  }

  .form-field select {
    cursor: pointer;
    -webkit-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236c757d' d='M3 5l3 3 3-3'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    padding-right: 28px;
  }

  .form-hidden-input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
    width: 1px;
    height: 1px;
  }

  .form-select,
  .form-date-picker {
    position: relative;
    width: 100%;
  }

  .form-select-trigger,
  .form-date-trigger {
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    text-align: left;
  }

  .form-select-trigger .dd-arrow,
  .form-date-trigger .dd-arrow {
    font-size: 10px;
    color: var(--text-muted);
    transition: transform 0.15s;
    flex-shrink: 0;
  }

  .form-select-trigger.open .dd-arrow,
  .form-date-trigger.open .dd-arrow {
    transform: rotate(180deg);
  }

  .form-select-value,
  .form-date-value {
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .form-select-value.placeholder,
  .form-date-value.placeholder {
    color: var(--text-muted);
  }

  .form-select-panel {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    z-index: 125;
    width: 100%;
    min-width: 180px;
    max-height: 260px;
    overflow-y: auto;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    animation: fadeIn 0.15s ease;
  }

  .form-select-option,
  .form-select-empty {
    width: 100%;
    border: none;
    background: transparent;
    color: var(--text);
    font-size: 12px;
    font-family: var(--font-head);
    text-align: left;
    padding: 8px 12px;
  }

  .form-select-option {
    cursor: pointer;
  }

  .form-select-option:hover {
    background: var(--bg-header);
  }

  .form-select-option.selected {
    background: var(--bg-card);
    font-weight: 600;
  }

  .form-select-empty {
    color: var(--text-muted);
  }

  .form-calendar-panel {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    z-index: 126;
    width: min(320px, calc(100vw - 48px));
    background: var(--card-bg);
    border: var(--border-width) solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 10px;
    user-select: none;
  }

  .form-calendar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .form-calendar-month {
    font-family: var(--font-head);
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .form-calendar-nav-btn {
    width: 28px;
    height: 28px;
    border: var(--border-width) solid var(--border);
    background: var(--card-bg);
    color: var(--text);
    box-shadow: var(--shadow-sm);
    font-family: var(--font-head);
    cursor: pointer;
    line-height: 1;
    transition: transform 0.1s, box-shadow 0.1s;
  }

  .form-calendar-nav-btn:hover {
    transform: translate(1px, 1px);
    box-shadow: var(--shadow-pressed);
  }

  .form-calendar-weekdays,
  .form-calendar-days {
    display: grid;
    grid-template-columns: repeat(7, minmax(0, 1fr));
    gap: 2px;
  }

  .form-calendar-weekday {
    font-family: var(--font-head);
    font-size: 10px;
    text-align: center;
    color: var(--text-muted);
    padding: 2px 0;
  }

  .form-calendar-day {
    border: var(--border-width) solid transparent;
    background: var(--card-bg);
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 12px;
    min-height: 32px;
    cursor: pointer;
    transition: transform 0.1s, box-shadow 0.1s, background-color 0.1s;
  }

  .form-calendar-day:hover {
    background: var(--highlight);
    transform: translate(1px, 1px);
    box-shadow: var(--shadow-pressed);
  }

  .form-calendar-day.other-month {
    opacity: 0.55;
  }

  .form-calendar-day.today {
    border-color: var(--border);
  }

  .form-calendar-day.selected {
    background: var(--text);
    color: var(--card-bg);
    border-color: var(--border);
  }

  .form-calendar-day:focus-visible {
    outline: 2px solid color-mix(in srgb, var(--highlight) 80%, transparent);
    outline-offset: 1px;
  }

  /* Multi-select checkboxes */
  .form-multiselect-options {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .form-multiselect-option {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    cursor: pointer;
    padding: 3px 0;
  }

  .form-multiselect-option input[type="checkbox"] {
    appearance: none;
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    margin: 0;
    border: var(--border-width) solid var(--border);
    border-radius: var(--radius);
    background: var(--card-bg);
    box-shadow: var(--shadow-sm);
    cursor: pointer;
    transition: transform 0.1s, box-shadow 0.1s, background-color 0.15s;
  }

  /* Radio group */
  .form-radio-options {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .form-radio-option {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    cursor: pointer;
    padding: 3px 0;
  }

  .form-radio-option input[type="radio"] {
    appearance: none;
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    margin: 0;
    border: var(--border-width) solid var(--border);
    border-radius: 50%;
    background: var(--card-bg);
    box-shadow: var(--shadow-sm);
    cursor: pointer;
    transition: transform 0.1s, box-shadow 0.1s, background-color 0.15s;
  }

  /* Slider */
  .form-slider-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .form-slider-row input[type="range"] {
    flex: 1;
    accent-color: var(--accent);
    cursor: pointer;
    height: 4px;
  }

  .form-slider-value {
    font-size: 12px;
    font-family: var(--mono);
    color: var(--text-muted);
    min-width: 40px;
    text-align: right;
  }

  /* Range slider (two handles) */
  .form-range-slider-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .form-range-slider-row input[type="range"] {
    flex: 1;
    accent-color: var(--accent);
    cursor: pointer;
    height: 4px;
  }

  .form-range-value {
    font-size: 12px;
    font-family: var(--mono);
    color: var(--text-muted);
    min-width: 80px;
    text-align: center;
  }

  /* Checkbox / Toggle inline */
  .form-check-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 2px 0;
  }

  .form-check-row input[type="checkbox"] {
    appearance: none;
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    margin: 0;
    border: var(--border-width) solid var(--border);
    border-radius: var(--radius);
    background: var(--card-bg);
    box-shadow: var(--shadow-sm);
    cursor: pointer;
    transition: transform 0.1s, box-shadow 0.1s, background-color 0.15s;
  }

  .form-check-label {
    font-size: 13px;
    cursor: pointer;
  }

  /* Toggle switch */
  .form-toggle-switch {
    position: relative;
    width: 36px;
    height: 20px;
    display: inline-block;
    flex-shrink: 0;
  }

  .form-toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .form-toggle-track {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background: var(--border);
    border-radius: 20px;
    transition: background 0.2s;
  }

  .form-toggle-track::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    left: 2px;
    bottom: 2px;
    background: white;
    border-radius: 50%;
    transition: transform 0.2s;
  }

  .form-toggle-switch input:checked + .form-toggle-track {
    background: var(--accent);
  }

  .form-toggle-switch input:checked + .form-toggle-track::after {
    transform: translateX(16px);
  }

  /* Date range */
  .form-date-range-row {
    display: flex;
    align-items: flex-start;
    gap: 8px;
  }

  .form-date-range-sep {
    font-size: 12px;
    color: var(--text-muted);
    align-self: center;
  }

  /* Frozen form (confirmed) */
  .form-frozen {
    display: flex;
    flex-wrap: wrap;
    gap: 6px 16px;
    font-size: 13px;
  }

  .form-frozen-item {
    display: inline-flex;
    gap: 4px;
  }

  .form-frozen-item .frozen-label {
    color: var(--text-muted);
  }

  .form-frozen-item .frozen-value {
    font-weight: 500;
  }

  /* Controls bar for hybrid cards */
  .card-controls-bar {
    padding: 10px 16px;
    border-top: 1px solid var(--border);
    background: var(--bg-card);
  }

  .card-controls-bar .form-fields {
    gap: 10px;
  }

  /* Table row checkboxes for selection */
  .table-wrapper th.select-col,
  .table-wrapper td.select-col {
    width: 32px;
    text-align: center;
    padding: 5px 4px;
  }

  .table-wrapper td.select-col input[type="checkbox"],
  .table-wrapper th.select-col input[type="checkbox"] {
    appearance: none;
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    margin: 0;
    border: var(--border-width) solid var(--border);
    border-radius: var(--radius);
    background: var(--card-bg);
    box-shadow: var(--shadow-sm);
    cursor: pointer;
    transition: transform 0.1s, box-shadow 0.1s, background-color 0.15s;
  }

  .form-multiselect-option input[type="checkbox"]:hover,
  .form-check-row input[type="checkbox"]:hover,
  .table-wrapper td.select-col input[type="checkbox"]:hover,
  .table-wrapper th.select-col input[type="checkbox"]:hover {
    transform: translate(1px, 1px);
    box-shadow: var(--shadow-pressed);
  }

  .form-radio-option input[type="radio"]:hover {
    transform: translate(1px, 1px);
    box-shadow: var(--shadow-pressed);
  }

  .form-multiselect-option input[type="checkbox"]:checked,
  .form-check-row input[type="checkbox"]:checked,
  .table-wrapper td.select-col input[type="checkbox"]:checked,
  .table-wrapper th.select-col input[type="checkbox"]:checked {
    background-color: var(--text);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='8' viewBox='0 0 10 8'%3E%3Cpath fill='none' stroke='currentColor' stroke-width='1.8' stroke-linecap='round' stroke-linejoin='round' d='M1 4l2.5 2.5L9 1'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
    color: var(--card-bg);
  }

  .form-radio-option input[type="radio"]:checked {
    background: radial-gradient(circle at center, var(--card-bg) 0 34%, var(--text) 40%);
  }

  .form-multiselect-option input[type="checkbox"]:focus-visible,
  .form-check-row input[type="checkbox"]:focus-visible,
  .table-wrapper td.select-col input[type="checkbox"]:focus-visible,
  .table-wrapper th.select-col input[type="checkbox"]:focus-visible,
  .form-radio-option input[type="radio"]:focus-visible {
    outline: 2px solid color-mix(in srgb, var(--highlight) 75%, transparent);
    outline-offset: 1px;
  }


  /* Card flash animation on update */
  @keyframes flashHighlight {
    0% { background: color-mix(in srgb, var(--accent) 15%, var(--bg)); }
    100% { background: var(--bg); }
  }

  .card.flash { animation: flashHighlight 0.6s ease; }


  /* Card updating overlay */
  .card-updating-overlay {
    position: absolute;
    inset: 0;
    background: color-mix(in srgb, var(--bg) 60%, transparent);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2;
    border-radius: var(--radius);
  }

  .card-updating-overlay::before {
    content: '';
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  .card { position: relative; }

  /* Action badge (Confirmed/Skipped) */
  .sent-badge {
    display: inline-block;
    font-size: 11px;
    color: var(--success);
    font-weight: 500;
    padding: 2px 6px;
  }

  /* Selection badge */
  .selection-badge {
    display: inline-block;
    font-size: 10px;
    font-weight: 600;
    padding: 1px 6px;
    border-radius: 9px;
    background: var(--accent);
    color: white;
    margin-left: 4px;
  }

  /* Agent status */
  #agent-status {
    font-size: 12px;
    color: var(--text-muted);
    font-style: italic;
  }

  /* Quick action buttons (secondary) */
  .response-btn-action {
    background: var(--bg-header);
    color: var(--text);
    border-color: var(--border);
  }

  .response-btn-action:hover {
    background: var(--bg-card);
    border-color: var(--accent);
    color: var(--accent);
  }

  /* ================================================================
     NEOBRUTALIST DESIGN OVERRIDES
     ================================================================ */
  :root {
    --bg: #f7f5f0;
    --card-bg: #ffffff;
    --text: #1a1a1a;
    --text-muted: #888888;
    --border: #1a1a1a;
    --border-width: 2px;

    --table-color: #3b82f6;
    --table-bg: #dbeafe;
    --md-color: #8b5cf6;
    --md-bg: #ede9fe;
    --chart-color: #10b981;
    --chart-bg: #d1fae5;
    --kv-color: #f59e0b;
    --kv-bg: #fef3c7;
    --form-color: #ec4899;
    --form-bg: #fce7f3;
    --decision-color: #ef4444;
    --decision-bg: #fee2e2;
    --image-color: #06b6d4;
    --image-bg: #cffafe;
    --section-color: #1a1a1a;

    --success: #16a34a;
    --success-bg: #dcfce7;
    --warning: #d97706;
    --error: #dc2626;
    --highlight: #ffef5c;

    --shadow: 4px 4px 0 #1a1a1a;
    --shadow-sm: 2px 2px 0 #1a1a1a;
    --shadow-pressed: 1px 1px 0 #1a1a1a;

    --font-head: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-body: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-mono: 'DM Mono', 'SF Mono', Menlo, Consolas, monospace;

    --radius: 0px;
    --pin-color: #f59e0b;

    /* Legacy aliases retained for existing rules */
    --bg-card: var(--card-bg);
    --bg-header: #ece8dc;
    --accent: var(--table-color);
    --accent-hover: #2563eb;
    --font: var(--font-body);
    --mono: var(--font-mono);
  }

  [data-theme="dark"] {
    --bg: #1a1a1a;
    --card-bg: #2a2a2a;
    --text: #e5e5e5;
    --text-muted: #888888;
    --border: #e5e5e5;

    --table-bg: #1e3a5f;
    --md-bg: #2d1f5e;
    --chart-bg: #14412e;
    --kv-bg: #3d2e0a;
    --form-bg: #3d1a2e;
    --decision-bg: #3d1a1a;
    --image-bg: #0a3d4a;

    --shadow: 4px 4px 0 #555555;
    --shadow-sm: 2px 2px 0 #555555;
    --shadow-pressed: 1px 1px 0 #555555;

    --highlight: #4a4520;
    --success-bg: #14412e;
    --bg-card: var(--card-bg);
    --bg-header: #232323;
    --accent: var(--table-color);
    --accent-hover: #60a5fa;
  }

  body {
    font-family: var(--font-body);
    background: var(--bg);
    color: var(--text);
  }

  .header {
    background: var(--card-bg);
    border-bottom: 3px solid var(--border);
    padding: 10px 32px;
  }

  .header h1 {
    font-family: var(--font-head);
    font-size: 18px;
    font-weight: 700;
    letter-spacing: 0;
  }

  .btn,
  .run-dropdown-trigger,
  .export-dropdown-panel,
  .run-dropdown-panel,
  .table-search,
  .table-pager button,
  .export-btn,
  .response-btn,
  .confirm-actions button,
  .row-detail-close,
  .form-field select,
  .form-field input[type="text"],
  .form-field input[type="number"],
  .form-field input[type="date"],
  .form-select-trigger,
  .form-date-trigger,
  .form-select-panel,
  .form-calendar-panel,
  .form-calendar-nav-btn,
  .response-message-input {
    border-radius: var(--radius);
  }

  .btn,
  .run-dropdown-trigger {
    padding: 6px 14px;
    border: var(--border-width) solid var(--border);
    background: var(--card-bg);
    color: var(--text);
    font-family: var(--font-head);
    font-size: 12px;
    font-weight: 600;
    box-shadow: var(--shadow-sm);
    transition: transform 0.1s, box-shadow 0.1s;
  }

  .btn:hover,
  .run-dropdown-trigger:hover {
    transform: translate(1px, 1px);
    box-shadow: var(--shadow-pressed);
    border-color: var(--border);
    background: var(--card-bg);
  }

  .btn:active,
  .run-dropdown-trigger:active {
    transform: translate(2px, 2px);
    box-shadow: none;
  }

  .btn-icon {
    border: var(--border-width) solid var(--border);
    border-radius: var(--radius);
    background: var(--card-bg);
    color: var(--text);
    box-shadow: var(--shadow-sm);
    font-family: var(--font-head);
    font-size: 13px;
    transition: transform 0.1s, box-shadow 0.1s;
  }

  .btn-icon:hover {
    transform: translate(1px, 1px);
    box-shadow: var(--shadow-pressed);
    background: var(--card-bg);
    color: var(--text);
  }

  .run-dropdown-panel,
  .export-dropdown-panel {
    background: var(--card-bg);
    border: var(--border-width) solid var(--border);
    box-shadow: var(--shadow);
  }

  .run-dropdown-all:hover,
  .run-dropdown-entry:hover,
  .export-dropdown-item:hover {
    background: var(--highlight);
  }

  .run-dropdown-all,
  .run-dropdown-entry,
  .run-dropdown-group-label,
  .run-entry-meta,
  .run-meta-detail {
    font-family: var(--font-head);
  }

  .run-metadata-bar {
    font-family: var(--font-head);
  }

  .run-meta-edit-input {
    font-family: var(--font-mono);
    border: var(--border-width) solid var(--border);
    border-radius: var(--radius);
    background: var(--card-bg);
    box-shadow: var(--shadow-sm);
  }

  .feed {
    max-width: 1040px;
  }

  .card {
    border: var(--border-width) solid var(--border);
    border-radius: var(--radius);
    background: var(--card-bg);
    box-shadow: var(--shadow);
    transition: transform 0.1s, box-shadow 0.1s;
  }

  .card:hover {
    transform: translate(-1px, -1px);
    box-shadow: 5px 5px 0 var(--border);
  }

  .card-header {
    padding: 10px 14px;
    border-bottom: var(--border-width) solid var(--border);
    background: var(--card-bg);
    gap: 10px;
  }

  .card-header[data-type="table"] { background: var(--table-bg); }
  .card-header[data-type="markdown"] { background: var(--md-bg); }
  .card-header[data-type="plotly"] { background: var(--chart-bg); }
  .card-header[data-type="image"] { background: var(--image-bg); }
  .card-header[data-type="keyvalue"] { background: var(--kv-bg); }
  .card-header[data-type="form"] { background: var(--form-bg); }
  .card-header[data-type="decision"] { background: var(--decision-bg); }

  .card-type-icon {
    width: 28px;
    height: 28px;
    border: var(--border-width) solid var(--border);
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--font-head);
    font-size: 14px;
    font-weight: 700;
    flex-shrink: 0;
  }

  .card-type-icon[data-type="table"] { background: var(--table-color); color: #fff; }
  .card-type-icon[data-type="markdown"] { background: var(--md-color); color: #fff; }
  .card-type-icon[data-type="plotly"] { background: var(--chart-color); color: #fff; }
  .card-type-icon[data-type="image"] { background: var(--image-color); color: #fff; }
  .card-type-icon[data-type="keyvalue"] { background: var(--kv-color); color: #fff; }
  .card-type-icon[data-type="form"] { background: var(--form-color); color: #fff; }
  .card-type-icon[data-type="decision"] { background: var(--decision-color); color: #fff; }

  .card-title {
    font-family: var(--font-head);
    font-size: 14px;
    font-weight: 700;
  }

  .card-meta {
    font-family: var(--font-mono);
    font-size: 11px;
  }

  .card-collapse-btn,
  .card-action-btn {
    color: var(--text-muted);
  }

  .card-action-btn:hover,
  .card-collapse-btn:hover {
    color: var(--text);
    background: transparent;
  }

  .card-body {
    padding: 16px;
  }

  .card-provenance {
    padding: 6px 14px;
    border-top: 1px solid color-mix(in srgb, var(--border) 30%, transparent);
    font-family: var(--font-mono);
    font-size: 10px;
    gap: 12px;
  }

  .table-toolbar {
    padding: 8px 0 0;
    margin-bottom: 8px;
  }

  .table-wrapper table {
    font-family: var(--font-mono);
    border: var(--border-width) solid var(--border);
    box-shadow: var(--shadow-sm);
    background: var(--card-bg);
  }

  .table-wrapper th {
    padding: 8px 14px;
    border-bottom: var(--border-width) solid var(--border);
    font-family: var(--font-head);
    font-weight: 700;
    background: var(--table-bg);
  }

  .table-wrapper th:hover {
    background: var(--table-bg);
  }

  .table-wrapper td {
    padding: 6px 14px;
    border-bottom: 1px solid color-mix(in srgb, var(--border) 20%, transparent);
  }

  .table-wrapper tr:hover td {
    background: var(--table-bg);
  }

  .table-info {
    padding: 10px 14px;
    border-top: var(--border-width) solid var(--border);
    font-family: var(--font-head);
    font-size: 12px;
  }

  .table-pager button,
  .export-btn {
    border: var(--border-width) solid var(--border);
    background: var(--card-bg);
    font-family: var(--font-head);
    box-shadow: var(--shadow-sm);
    transition: transform 0.1s, box-shadow 0.1s;
  }

  .table-pager button:hover,
  .export-btn:hover {
    transform: translate(1px, 1px);
    box-shadow: var(--shadow-pressed);
    background: var(--card-bg);
    color: var(--text);
  }

  .table-search,
  .response-message-input,
  .form-field select,
  .form-field input[type="text"],
  .form-field input[type="number"],
  .form-field input[type="date"],
  .form-select-trigger,
  .form-date-trigger {
    border: var(--border-width) solid var(--border);
    background: var(--card-bg);
    font-family: var(--font-mono);
    box-shadow: var(--shadow-sm);
  }

  .table-search:focus,
  .response-message-input:focus,
  .form-field select:focus,
  .form-field input[type="text"]:focus,
  .form-field input[type="number"]:focus,
  .form-field input[type="date"]:focus,
  .form-select-trigger:focus-visible,
  .form-date-trigger:focus-visible {
    box-shadow: var(--shadow-pressed);
    border-color: var(--border);
  }

  .type-badge {
    border-radius: var(--radius);
    font-family: var(--font-mono);
    font-weight: 600;
    background: var(--card-bg);
  }

  .markdown-body {
    font-family: var(--font-body);
    font-size: 14px;
    line-height: 1.7;
  }

  .markdown-body h1,
  .markdown-body h2,
  .markdown-body h3 {
    font-family: var(--font-head);
    font-weight: 700;
  }

  .markdown-body code {
    font-family: var(--font-mono);
    background: var(--md-bg);
    border: 1px solid color-mix(in srgb, var(--border) 20%, transparent);
  }

  .markdown-body pre {
    background: var(--bg);
    border: var(--border-width) solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
  }

  .kv-key {
    font-family: var(--font-head);
    font-weight: 700;
    font-size: 12px;
  }

  .kv-value {
    font-family: var(--font-mono);
  }

  .section-divider {
    font-family: var(--font-head);
    font-weight: 700;
    color: var(--text);
    letter-spacing: 0;
  }

  .section-divider::before,
  .section-divider::after {
    height: 3px;
    background: var(--border);
  }

  .chart-loading {
    font-family: var(--font-head);
  }

  .chart-loading::before {
    border: var(--border-width) solid var(--border);
    border-top-color: var(--chart-color);
  }

  .image-container img {
    border: var(--border-width) solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
  }

  .card.waiting {
    border-color: var(--decision-color);
  }

  @keyframes subtlePulse {
    0%, 100% { box-shadow: var(--shadow); }
    50% { box-shadow: 0 0 0 3px color-mix(in srgb, var(--decision-color) 25%, transparent), var(--shadow); }
  }

  .card-response-ui {
    border-top: var(--border-width) solid var(--border);
    background: var(--decision-bg);
  }

  .response-prompt {
    font-family: var(--font-head);
    font-size: 13px;
    font-weight: 600;
  }

  .response-btn {
    border: var(--border-width) solid var(--border);
    font-family: var(--font-head);
    font-weight: 600;
    box-shadow: var(--shadow-sm);
    transition: transform 0.1s, box-shadow 0.1s;
  }

  .response-btn:hover {
    transform: translate(1px, 1px);
    box-shadow: var(--shadow-pressed);
  }

  .response-btn-confirm {
    background: var(--text);
    border-color: var(--border);
    color: var(--card-bg);
  }

  .response-btn-confirm:hover {
    background: var(--text);
    border-color: var(--border);
  }

  .response-btn-skip {
    background: var(--card-bg);
    color: var(--text-muted);
  }

  .form-field-label {
    font-family: var(--font-head);
    font-size: 12px;
    font-weight: 700;
  }

  .form-toggle-track {
    border-radius: 0;
    border: var(--border-width) solid var(--border);
    background: var(--card-bg);
  }

  .form-toggle-track::after {
    width: 12px;
    height: 12px;
    bottom: 0;
    left: 0;
    border-radius: 0;
    border: var(--border-width) solid var(--border);
    background: var(--text);
  }

  .form-toggle-switch input:checked + .form-toggle-track {
    background: var(--text);
  }

  .form-toggle-switch input:checked + .form-toggle-track::after {
    background: var(--card-bg);
  }

  .form-slider-row input[type="range"],
  .form-range-slider-row input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    height: 12px;
    background: var(--card-bg);
    border: var(--border-width) solid var(--border);
    border-radius: 0;
  }

  .form-slider-row input[type="range"]::-webkit-slider-thumb,
  .form-range-slider-row input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    border: var(--border-width) solid var(--border);
    border-radius: 0;
    background: var(--card-bg);
    box-shadow: var(--shadow-sm);
    cursor: pointer;
    transition: transform 0.1s, box-shadow 0.1s;
  }

  .form-slider-row input[type="range"]::-webkit-slider-thumb:hover,
  .form-range-slider-row input[type="range"]::-webkit-slider-thumb:hover {
    transform: translate(1px, 1px);
    box-shadow: var(--shadow-pressed);
  }

  .form-slider-row input[type="range"]::-moz-range-track,
  .form-range-slider-row input[type="range"]::-moz-range-track {
    height: 12px;
    border: var(--border-width) solid var(--border);
    border-radius: 0;
    background: var(--card-bg);
  }

  .form-slider-row input[type="range"]::-moz-range-thumb,
  .form-range-slider-row input[type="range"]::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border: var(--border-width) solid var(--border);
    border-radius: 0;
    background: var(--card-bg);
    box-shadow: var(--shadow-sm);
    cursor: pointer;
  }

  .form-frozen-item .frozen-label {
    font-family: var(--font-head);
  }

  .form-frozen-item .frozen-value {
    font-family: var(--font-mono);
    font-weight: 600;
  }

  .row-detail-panel {
    background: var(--card-bg);
    border-left: 3px solid var(--border);
    box-shadow: -4px 0 0 var(--border);
  }

  .row-detail-header {
    border-bottom: var(--border-width) solid var(--border);
    font-family: var(--font-head);
    font-size: 13px;
    font-weight: 700;
  }

  .row-detail-close {
    background: none;
    border: var(--border-width) solid var(--border);
    box-shadow: var(--shadow-sm);
  }

  .row-detail-close:hover {
    background: none;
    box-shadow: var(--shadow-pressed);
  }

  .confirm-dialog {
    background: var(--card-bg);
    border: 3px solid var(--border);
    border-radius: var(--radius);
    box-shadow: 6px 6px 0 var(--border);
    font-family: var(--font-body);
  }

  .confirm-dialog h3 {
    font-family: var(--font-head);
    font-size: 15px;
    font-weight: 700;
  }

  .confirm-actions button {
    border: var(--border-width) solid var(--border);
    font-family: var(--font-head);
    font-weight: 600;
    box-shadow: var(--shadow-sm);
  }

  .confirm-danger {
    background: var(--error);
    color: #fff;
    border-color: var(--border);
  }

  .footer {
    background: var(--card-bg);
    border-top: 3px solid var(--border);
    font-family: var(--font-mono);
    font-size: 11px;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border: var(--border-width) solid var(--border);
    border-radius: 0;
  }

  .copy-toast {
    background: var(--text);
    color: var(--card-bg);
    border: var(--border-width) solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
    font-family: var(--font-head);
    font-weight: 600;
  }

  .empty-state {
    font-family: var(--font-head);
  }

  .empty-state code {
    font-family: var(--font-mono);
    background: var(--card-bg);
    border: var(--border-width) solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
    padding: 4px 12px;
  }

  .selection-badge {
    border-radius: var(--radius);
    border: var(--border-width) solid var(--border);
    background: var(--highlight);
    color: var(--text);
    font-family: var(--font-head);
  }

  #agent-status {
    font-family: var(--font-mono);
    font-style: normal;
  }

  .table-wrapper th.select-col,
  .table-wrapper td.select-col {
    padding: 6px 4px;
  }

  .form-multiselect-option input[type="checkbox"],
  .form-check-row input[type="checkbox"],
  .table-wrapper td.select-col input[type="checkbox"],
  .table-wrapper th.select-col input[type="checkbox"] {
    border-radius: 4px;
  }

  @media (max-width: 720px) {
    .form-date-range-row {
      flex-direction: column;
      align-items: stretch;
    }

    .form-date-range-sep {
      align-self: flex-start;
      margin: -2px 0 2px;
    }

    .form-calendar-panel {
      width: min(320px, calc(100vw - 32px));
    }
  }

  /* ================================================================
     PRINT STYLES
     ================================================================ */
  @media print {
    body {
      background: white;
      color: black;
    }

    .header {
      position: static;
      background: white;
      border-bottom: 2px solid #333;
      padding: 8px 0;
    }

    .header-actions,
    .run-dropdown,
    .export-dropdown,
    .run-metadata-bar,
    .footer,
    .copy-toast,
    .confirm-overlay {
      display: none !important;
    }

    .feed {
      max-width: none;
      padding: 8px 0;
      min-height: auto;
    }

    .card {
      box-shadow: none;
      border: 1px solid #999;
      margin-bottom: 8px;
      animation: none;
      page-break-inside: avoid;
    }

    .card-header {
      background: #f5f5f5;
    }

    .card-body {
      padding: 8px 12px;
    }

    .table-scroll-cap {
      max-height: none !important;
      overflow: visible !important;
    }

    .table-toolbar {
      display: none;
    }

    table {
      font-size: 9pt;
    }

    th, td {
      padding: 3px 6px;
    }

    .card-actions,
    .response-actions {
      display: none;
    }

    .plotly-container {
      page-break-inside: avoid;
    }

    .card-provenance {
      font-size: 9pt;
      color: #666;
    }

    .run-separator {
      page-break-before: always;
      font-size: 10pt;
      font-weight: bold;
    }

    .run-separator:first-child {
      page-break-before: auto;
    }
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <h1>vitrine</h1>
    <div class="run-dropdown" id="run-dropdown">
      <button class="run-dropdown-trigger" id="run-dropdown-trigger" title="Browse runs">
        <span id="run-dropdown-label">All runs</span>
        <span class="dd-arrow">&#9662;</span>
      </button>
      <div class="run-dropdown-panel" id="run-dropdown-panel" style="display: none;"></div>
    </div>
  </div>
  <div class="header-actions">
    <span id="agent-status"></span>
    <div class="export-dropdown" id="export-dropdown">
      <button class="btn" id="export-btn" title="Export run">&#8615; Export</button>
      <div class="export-dropdown-panel" id="export-dropdown-panel" style="display: none;"></div>
    </div>
    <button class="btn-icon" id="theme-toggle" title="Toggle theme">&#9789;</button>
  </div>
</div>

<div class="run-metadata-bar" id="run-metadata-bar">
  <span class="run-meta-label" id="run-meta-label"></span>
  <span class="run-meta-sep">&middot;</span>
  <span id="run-meta-detail"></span>
</div>

<div class="feed" id="feed">
  <div class="empty-state" id="empty-state">
    <div style="font-size: 32px; opacity: 0.3;">&#9671;</div>
    <div style="font-size: 15px; font-weight: 500;">No analyses yet</div>
    <div style="font-size: 13px;">Run an agent to get started</div>
    <div><code>from m4.vitrine import show</code></div>
  </div>
</div>

<div class="footer">
  <div id="status">
    <span class="status-dot status-connecting"></span>
    Connecting...
  </div>
  <div id="session-info"></div>
  <div id="card-count">0 cards</div>
</div>

<div class="copy-toast" id="copy-toast">Copied to clipboard</div>

<script>
(function() {
  'use strict';

  // ================================================================
  // STATE & DOM REFERENCES
  // ================================================================
  var state = {
    ws: null,
    cards: [],
    connected: false,
    reconnectDelay: 1000,
    reconnectTimer: null,
    markedLoaded: false,
    plotlyLoaded: false,
    plotlyCallbacks: [],
    runIds: [],
    activeRunFilter: '',
    runs: [],
    activeRunId: null,
    dropdownOpen: false,
    liveMode: false,
    _autoSelectPending: false,
    selections: {},
  };

  var TYPE_LETTERS = {
    table: 'T',
    markdown: 'M',
    plotly: 'P',
    image: 'I',
    keyvalue: 'K',
    form: 'F',
    decision: '!',
  };

  var feed = document.getElementById('feed');
  var emptyState = document.getElementById('empty-state');
  var statusEl = document.getElementById('status');
  var sessionInfoEl = document.getElementById('session-info');
  var cardCountEl = document.getElementById('card-count');
  var themeToggleEl = document.getElementById('theme-toggle');
  var copyToastEl = document.getElementById('copy-toast');
  var runDropdownTrigger = document.getElementById('run-dropdown-trigger');
  var runDropdownPanel = document.getElementById('run-dropdown-panel');
  var runDropdownLabel = document.getElementById('run-dropdown-label');
  var runMetaBar = document.getElementById('run-metadata-bar');
  var runMetaLabel = document.getElementById('run-meta-label');
  var runMetaDetail = document.getElementById('run-meta-detail');

  // ================================================================
  // THEME
  // ================================================================
  function initTheme() {
    var saved = localStorage.getItem('m4-vitrine-theme');
    if (saved === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
      themeToggleEl.innerHTML = '&#9788;';
    }
  }

  themeToggleEl.onclick = function() {
    var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    if (isDark) {
      document.documentElement.removeAttribute('data-theme');
      localStorage.setItem('m4-vitrine-theme', 'light');
      themeToggleEl.innerHTML = '&#9789;';
    } else {
      document.documentElement.setAttribute('data-theme', 'dark');
      localStorage.setItem('m4-vitrine-theme', 'dark');
      themeToggleEl.innerHTML = '&#9788;';
    }
  };

  initTheme();

  // ================================================================
  // RUN MANAGEMENT — dropdown, selection, metadata, rename, delete
  // ================================================================
  runDropdownTrigger.onclick = function(e) {
    e.stopPropagation();
    if (state.dropdownOpen) {
      closeDropdown();
    } else {
      openDropdown();
    }
  };

  function openDropdown() {
    state.dropdownOpen = true;
    runDropdownTrigger.classList.add('open');
    renderDropdown();
    runDropdownPanel.style.display = '';
    // Close on outside click
    setTimeout(function() {
      document.addEventListener('mousedown', _closeDropdownOutside);
    }, 0);
  }

  function closeDropdown() {
    state.dropdownOpen = false;
    runDropdownTrigger.classList.remove('open');
    runDropdownPanel.style.display = 'none';
    document.removeEventListener('mousedown', _closeDropdownOutside);
  }

  function _closeDropdownOutside(e) {
    var dd = document.getElementById('run-dropdown');
    if (dd && !dd.contains(e.target)) {
      closeDropdown();
    }
  }

  function dateGroupLabel(isoStr) {
    if (!isoStr) return 'Unknown';
    var d = new Date(isoStr);
    var today = new Date();
    today.setHours(0, 0, 0, 0);
    var yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    var dDate = new Date(d);
    dDate.setHours(0, 0, 0, 0);

    if (dDate.getTime() === today.getTime()) return 'Today';
    if (dDate.getTime() === yesterday.getTime()) return 'Yesterday';
    return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
  }

  function formatRunTime(isoStr) {
    if (!isoStr) return '';
    var d = new Date(isoStr);
    return d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
  }

  function renderDropdown() {
    runDropdownPanel.innerHTML = '';

    // "All runs" option
    var allOpt = document.createElement('div');
    allOpt.className = 'run-dropdown-all' + (!state.activeRunFilter ? ' selected' : '');
    allOpt.textContent = 'All runs';
    allOpt.onclick = function(e) {
      e.stopPropagation();
      selectRun('');
    };
    runDropdownPanel.appendChild(allOpt);

    if (state.runs.length === 0) {
      var emptyMsg = document.createElement('div');
      emptyMsg.className = 'run-dropdown-empty';
      emptyMsg.textContent = 'No runs yet';
      runDropdownPanel.appendChild(emptyMsg);
      return;
    }

    // Group runs by date
    var groupOrder = [];
    var groups = {};
    state.runs.forEach(function(run) {
      var gl = dateGroupLabel(run.start_time);
      if (!groups[gl]) {
        groups[gl] = [];
        groupOrder.push(gl);
      }
      groups[gl].push(run);
    });

    groupOrder.forEach(function(groupLabel) {
      var gh = document.createElement('div');
      gh.className = 'run-dropdown-group-label';
      gh.textContent = groupLabel;
      runDropdownPanel.appendChild(gh);

      groups[groupLabel].forEach(function(run) {
        var entry = document.createElement('div');
        entry.className = 'run-dropdown-entry' + (state.activeRunFilter === run.label ? ' selected' : '');

        var dot = document.createElement('span');
        dot.className = 'run-dot ' + (state.activeRunId === run.label ? 'active' : 'inactive');
        entry.appendChild(dot);

        var labelEl = document.createElement('span');
        labelEl.className = 'run-entry-label';
        labelEl.textContent = run.label;
        entry.appendChild(labelEl);

        var meta = document.createElement('span');
        meta.className = 'run-entry-meta';
        meta.textContent = (run.card_count || 0) + ' cards';
        if (run.start_time) meta.textContent += '  ' + formatRunTime(run.start_time);
        entry.appendChild(meta);

        var expBtn = document.createElement('button');
        expBtn.type = 'button';
        expBtn.className = 'run-export-btn';
        expBtn.innerHTML = '&#8615;';
        expBtn.title = 'Export run';
        expBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          e.preventDefault();
          exportRun(run.label, 'html');
          closeDropdown();
        });
        entry.appendChild(expBtn);

        var delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'run-delete-btn';
        delBtn.innerHTML = '&times;';
        delBtn.title = 'Delete run';
        delBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          e.preventDefault();
          deleteRun(run.label);
        });
        entry.appendChild(delBtn);

        entry.onclick = function(e) {
          e.stopPropagation();
          selectRun(run.label);
        };
        runDropdownPanel.appendChild(entry);
      });
    });
  }

  function selectRun(label) {
    state.activeRunFilter = label;
    closeDropdown();
    updateDropdownTrigger();
    applyRunFilter();
    updateRunMetadataBar();
  }

  function updateDropdownTrigger() {
    if (state.activeRunFilter) {
      runDropdownLabel.textContent = state.activeRunFilter;
    } else {
      runDropdownLabel.textContent = 'All runs';
    }
  }

  function updateRunMetadataBar() {
    if (!state.activeRunFilter) {
      runMetaBar.classList.remove('visible');
      return;
    }
    var run = null;
    for (var i = 0; i < state.runs.length; i++) {
      if (state.runs[i].label === state.activeRunFilter) {
        run = state.runs[i];
        break;
      }
    }
    if (!run) {
      runMetaBar.classList.remove('visible');
      return;
    }
    runMetaLabel.textContent = run.label;
    var parts = [];
    if (run.card_count !== undefined) parts.push(run.card_count + ' card' + (run.card_count !== 1 ? 's' : ''));
    if (run.start_time) parts.push(new Date(run.start_time).toLocaleDateString());
    runMetaDetail.textContent = parts.join(' \u00b7 ');
    runMetaBar.classList.add('visible');
  }

  function showConfirmModal(title, message, confirmLabel, onConfirm) {
    var overlay = document.createElement('div');
    overlay.className = 'confirm-overlay';
    var dialog = document.createElement('div');
    dialog.className = 'confirm-dialog';
    dialog.innerHTML = '<h3></h3><p></p><div class="confirm-actions"><button class="confirm-cancel">Cancel</button><button class="confirm-danger"></button></div>';
    dialog.querySelector('h3').textContent = title;
    dialog.querySelector('p').textContent = message;
    dialog.querySelector('.confirm-danger').textContent = confirmLabel;
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);

    function dismiss() { overlay.remove(); }
    overlay.addEventListener('click', function(e) { if (e.target === overlay) dismiss(); });
    dialog.querySelector('.confirm-cancel').onclick = dismiss;
    dialog.querySelector('.confirm-danger').onclick = function() { dismiss(); onConfirm(); };
    dialog.querySelector('.confirm-danger').focus();

    // Esc to cancel
    function onKey(e) { if (e.key === 'Escape') { dismiss(); document.removeEventListener('keydown', onKey); } }
    document.addEventListener('keydown', onKey);
  }

  function deleteRun(label) {
    showConfirmModal(
      'Delete run',
      'Delete "' + label + '"? This cannot be undone.',
      'Delete',
      function() {
        closeDropdown();
        fetch('/api/runs/' + encodeURIComponent(label), { method: 'DELETE' })
          .then(function(r) {
            if (!r.ok) throw new Error('Server returned ' + r.status);
            return r.json();
          })
          .then(function(data) {
            if (data.status === 'ok') {
              state.runs = state.runs.filter(function(r) { return r.label !== label; });
              state.runIds = state.runIds.filter(function(id) { return id !== label; });
              var cards = feed.querySelectorAll('.card[data-run-id="' + label + '"], .section-divider[data-run-id="' + label + '"], .run-separator[data-run-separator="' + label + '"]');
              cards.forEach(function(el) { el.remove(); });
              state.cards = state.cards.filter(function(c) { return c.run_id !== label; });
              if (state.activeRunFilter === label) {
                selectRun('');
              } else {
                renderDropdown();
              }
              updateCardCount();
              showToast('Run deleted');
              if (state.cards.length === 0) showEmptyState();
            } else {
              showToast(data.error || 'Delete failed');
            }
          })
          .catch(function(err) {
            console.error('Delete run error:', err);
            showToast('Failed to delete run');
          });
      }
    );
  }

  // ================================================================
  // EXPORT
  // ================================================================
  var exportBtn = document.getElementById('export-btn');
  var exportDropdownPanel = document.getElementById('export-dropdown-panel');
  var exportDropdownOpen = false;

  exportBtn.onclick = function(e) {
    e.stopPropagation();
    if (exportDropdownOpen) {
      closeExportDropdown();
    } else {
      openExportDropdown();
    }
  };

  function openExportDropdown() {
    exportDropdownOpen = true;
    renderExportDropdown();
    exportDropdownPanel.style.display = '';
    setTimeout(function() {
      document.addEventListener('mousedown', _closeExportOutside);
    }, 0);
  }

  function closeExportDropdown() {
    exportDropdownOpen = false;
    exportDropdownPanel.style.display = 'none';
    document.removeEventListener('mousedown', _closeExportOutside);
  }

  function _closeExportOutside(e) {
    var dd = document.getElementById('export-dropdown');
    if (dd && !dd.contains(e.target)) {
      closeExportDropdown();
    }
  }

  function renderExportDropdown() {
    exportDropdownPanel.innerHTML = '';

    var runLabel = state.activeRunFilter || null;
    var label = runLabel ? runLabel : 'all runs';

    // HTML export
    var htmlItem = document.createElement('button');
    htmlItem.className = 'export-dropdown-item';
    htmlItem.innerHTML = '<span class="export-icon">&#128196;</span> Export as HTML';
    htmlItem.onclick = function(e) {
      e.stopPropagation();
      closeExportDropdown();
      exportRun(runLabel, 'html');
    };
    exportDropdownPanel.appendChild(htmlItem);

    // JSON export
    var jsonItem = document.createElement('button');
    jsonItem.className = 'export-dropdown-item';
    jsonItem.innerHTML = '<span class="export-icon">&#128230;</span> Export as JSON';
    jsonItem.onclick = function(e) {
      e.stopPropagation();
      closeExportDropdown();
      exportRun(runLabel, 'json');
    };
    exportDropdownPanel.appendChild(jsonItem);

    // Separator
    var sep = document.createElement('div');
    sep.className = 'export-dropdown-sep';
    exportDropdownPanel.appendChild(sep);

    // Print
    var printItem = document.createElement('button');
    printItem.className = 'export-dropdown-item';
    printItem.innerHTML = '<span class="export-icon">&#128424;</span> Print (Ctrl+P)';
    printItem.onclick = function(e) {
      e.stopPropagation();
      closeExportDropdown();
      window.print();
    };
    exportDropdownPanel.appendChild(printItem);
  }

  function exportRun(runLabel, format) {
    var url;
    if (runLabel) {
      url = '/api/runs/' + encodeURIComponent(runLabel) + '/export?format=' + format;
    } else {
      url = '/api/export?format=' + format;
    }
    // Trigger download
    var a = document.createElement('a');
    a.href = url;
    a.download = '';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    showToast('Export started');
  }

  function startEditRunName() {
    // Only works when a specific run is selected
    if (!state.activeRunFilter) return;
    // Prevent double-edit
    if (runMetaBar.querySelector('.run-meta-edit-wrap')) return;

    var run = null;
    for (var i = 0; i < state.runs.length; i++) {
      if (state.runs[i].label === state.activeRunFilter) { run = state.runs[i]; break; }
    }
    if (!run) return;

    var originalLabel = run.label;
    runMetaLabel.style.display = 'none';

    var wrap = document.createElement('span');
    wrap.className = 'run-meta-edit-wrap';

    var input = document.createElement('input');
    input.type = 'text';
    input.className = 'run-meta-edit-input';
    input.value = originalLabel;
    wrap.appendChild(input);

    var hintEl = document.createElement('span');
    hintEl.className = 'run-meta-edit-hint';
    wrap.appendChild(hintEl);

    runMetaLabel.parentNode.insertBefore(wrap, runMetaLabel);
    input.focus();
    input.select();

    function validate(val) {
      val = val.trim();
      if (!val) return 'Name cannot be empty';
      if (val === originalLabel) return '';
      for (var i = 0; i < state.runs.length; i++) {
        if (state.runs[i].label === val) return 'Name already in use';
      }
      return '';
    }

    input.addEventListener('input', function() {
      var err = validate(input.value);
      if (err) {
        input.classList.add('invalid');
        hintEl.textContent = err;
      } else {
        input.classList.remove('invalid');
        hintEl.textContent = '';
      }
    });

    var committed = false;
    function commit() {
      if (committed) return;
      committed = true;
      var newLabel = input.value.trim();
      var err = validate(newLabel);
      if (err && newLabel !== originalLabel) { cleanup(); return; }
      if (!newLabel || newLabel === originalLabel) { cleanup(); return; }

      fetch('/api/runs/' + encodeURIComponent(originalLabel) + '/rename', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ new_label: newLabel })
      })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.status === 'ok') {
            run.label = newLabel;
            state.runIds = state.runIds.map(function(id) { return id === originalLabel ? newLabel : id; });
            state.cards.forEach(function(c) { if (c.run_id === originalLabel) c.run_id = newLabel; });
            var els = feed.querySelectorAll('[data-run-id="' + originalLabel + '"]');
            els.forEach(function(el) { el.setAttribute('data-run-id', newLabel); });
            var seps = feed.querySelectorAll('[data-run-separator="' + originalLabel + '"]');
            seps.forEach(function(el) { el.setAttribute('data-run-separator', newLabel); });
            state.activeRunFilter = newLabel;
            updateDropdownTrigger();
            showToast('Run renamed');
          } else {
            showToast(data.error || 'Rename failed');
          }
          cleanup();
        })
        .catch(function() { showToast('Failed to rename run'); cleanup(); });
    }

    function cleanup() {
      if (wrap.parentNode) wrap.parentNode.removeChild(wrap);
      runMetaLabel.style.display = '';
      runMetaLabel.textContent = run.label;
    }

    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') { e.preventDefault(); commit(); }
      if (e.key === 'Escape') { e.preventDefault(); cleanup(); }
    });
    input.addEventListener('blur', function() { setTimeout(commit, 100); });
  }

  // Click the run title in the metadata bar to rename
  runMetaLabel.addEventListener('click', startEditRunName);

  function trackRunId(runId) {
    if (!runId || state.runIds.indexOf(runId) !== -1) return;
    state.runIds.push(runId);
  }

  function insertRunSeparators() {
    // Remove existing separators
    feed.querySelectorAll('.run-separator').forEach(function(el) { el.remove(); });

    var items = feed.querySelectorAll('.card, .section-divider');
    var lastRunId = null;

    items.forEach(function(el) {
      var runId = el.dataset.runId || '';
      if (runId && runId !== lastRunId) {
        var run = null;
        for (var i = 0; i < state.runs.length; i++) {
          if (state.runs[i].label === runId) { run = state.runs[i]; break; }
        }
        var sep = document.createElement('div');
        sep.className = 'run-separator';
        sep.dataset.runSeparator = runId;
        var text = runId;
        if (run && run.start_time) text += ' \u00b7 ' + dateGroupLabel(run.start_time) + ' ' + formatRunTime(run.start_time);
        if (run && run.card_count) text += ' \u00b7 ' + run.card_count + ' cards';
        sep.textContent = text;
        el.parentNode.insertBefore(sep, el);
        lastRunId = runId;
      } else if (runId) {
        lastRunId = runId;
      }
    });
  }

  function applyRunFilter() {
    var filter = state.activeRunFilter;

    // Remove existing run separators first
    feed.querySelectorAll('.run-separator').forEach(function(el) { el.remove(); });

    var items = feed.querySelectorAll('.card, .section-divider');

    if (!filter) {
      // "All runs" mode: show everything, add run separators
      items.forEach(function(el) { el.classList.remove('hidden-by-filter'); });
      if (items.length > 0) insertRunSeparators();
    } else {
      // Specific run: show matching cards only
      items.forEach(function(el) {
        var elRun = el.dataset.runId || '';
        if (elRun === filter || !elRun) {
          el.classList.remove('hidden-by-filter');
        } else {
          el.classList.add('hidden-by-filter');
        }
      });
    }

    updateCardCount();
  }

  // ================================================================
  // WEBSOCKET — connect, reconnect, message dispatch
  // ================================================================
  function connect() {
    if (state.reconnectTimer) {
      clearTimeout(state.reconnectTimer);
      state.reconnectTimer = null;
    }
    updateStatus('connecting');

    var protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    var ws;
    try {
      ws = new WebSocket(protocol + '//' + location.host + '/ws');
    } catch (e) {
      scheduleReconnect();
      return;
    }

    ws.onopen = function() {
      state.ws = ws;
      state.connected = true;
      state.reconnectDelay = 1000;
      state.liveMode = false;
      updateStatus('connected');
      loadSessionInfo();
      loadRuns();
      // After replay completes (~500ms), enable live auto-switching
      setTimeout(function() { state.liveMode = true; }, 500);
    };

    ws.onmessage = function(event) {
      try {
        var msg = JSON.parse(event.data);
        handleMessage(msg);
      } catch (e) {
        console.error('Failed to parse message:', e);
      }
    };

    ws.onclose = function() {
      state.connected = false;
      state.ws = null;
      updateStatus('disconnected');
      scheduleReconnect();
    };

    ws.onerror = function() {
      ws.close();
    };
  }

  function scheduleReconnect() {
    state.reconnectTimer = setTimeout(connect, state.reconnectDelay);
    state.reconnectDelay = Math.min(state.reconnectDelay * 2, 15000);
  }

  function handleMessage(msg) {
    switch (msg.type) {
      case 'display.add':
        addCard(msg.card);
        break;
      case 'display.section':
        addSection(msg.title, msg.run_id);
        break;
      case 'display.update':
        updateCard(msg.card_id, msg.card);
        break;
      case 'vitrine.status':
      case 'display.status':
        updateAgentStatus(msg.text || msg.status || '');
        break;
    }
  }

  // ================================================================
  // CARD RENDERING — addCard, updateCard, copy, toast
  // ================================================================
  function addCard(cardData) {
    // Remove empty state if present
    var empty = document.getElementById('empty-state');
    if (empty && empty.parentNode) {
      empty.remove();
    }

    // Deduplicate on reconnect replay
    var existing = document.getElementById('card-' + cardData.card_id);
    if (existing) return;

    state.cards.push(cardData);
    trackRunId(cardData.run_id);

    // Track active run and auto-switch
    if (cardData.run_id) {
      state.activeRunId = cardData.run_id;
      if (state.liveMode && state.activeRunFilter !== cardData.run_id) {
        // Auto-switch to the new card's run
        state.activeRunFilter = cardData.run_id;
        updateDropdownTrigger();
        // Defer full filter update to batch rapid arrivals
        if (!state._autoSelectPending) {
          state._autoSelectPending = true;
          requestAnimationFrame(function() {
            state._autoSelectPending = false;
            applyRunFilter();
            updateRunMetadataBar();
            // Refresh run list to get updated card counts
            loadRuns();
          });
        }
      }
    }

    var el = document.createElement('div');
    el.className = 'card';
    if (cardData.pinned) el.className += ' pinned';
    el.id = 'card-' + cardData.card_id;
    el.dataset.runId = cardData.run_id || '';
    el.dataset.cardId = cardData.card_id;

    // Header
    var header = document.createElement('div');
    header.className = 'card-header';
    var headerType = cardData.response_requested ? 'decision' : cardData.card_type;
    header.setAttribute('data-type', headerType);

    // Collapse toggle
    var collapseBtn = document.createElement('button');
    collapseBtn.className = 'card-collapse-btn';
    collapseBtn.innerHTML = '&#9660;';
    collapseBtn.title = 'Collapse';
    collapseBtn.onclick = function() {
      var body = el.querySelector('.card-body');
      var prov = el.querySelector('.card-provenance');
      var isCollapsed = collapseBtn.classList.toggle('collapsed');
      if (body) body.classList.toggle('collapsed', isCollapsed);
      if (prov) prov.classList.toggle('collapsed', isCollapsed);
      collapseBtn.title = isCollapsed ? 'Expand' : 'Collapse';
    };
    header.appendChild(collapseBtn);

    // Type icon
    var typeIcon = document.createElement('div');
    typeIcon.className = 'card-type-icon';
    typeIcon.setAttribute('data-type', headerType);
    typeIcon.textContent = TYPE_LETTERS[headerType] || '?';
    header.appendChild(typeIcon);

    // Title
    var title = document.createElement('span');
    title.className = 'card-title';
    title.textContent = cardData.title || cardData.card_type;
    header.appendChild(title);

    // Timestamp
    var meta = document.createElement('span');
    meta.className = 'card-meta';
    if (cardData.timestamp) {
      meta.textContent = new Date(cardData.timestamp).toLocaleTimeString();
    }
    header.appendChild(meta);

    // Action buttons
    var actions = document.createElement('div');
    actions.className = 'card-actions';

    // Copy button
    var copyBtn = document.createElement('button');
    copyBtn.className = 'card-action-btn';
    copyBtn.innerHTML = '&#128203;';
    copyBtn.title = 'Copy content';
    copyBtn.onclick = function(e) {
      e.stopPropagation();
      copyCardContent(cardData, copyBtn);
    };
    actions.appendChild(copyBtn);

    // Pin button
    var pinBtn = document.createElement('button');
    pinBtn.className = 'card-action-btn' + (cardData.pinned ? ' pinned' : '');
    pinBtn.innerHTML = '&#128204;';
    pinBtn.title = cardData.pinned ? 'Unpin' : 'Pin';
    pinBtn.onclick = function(e) {
      e.stopPropagation();
      cardData.pinned = !cardData.pinned;
      pinBtn.classList.toggle('pinned', cardData.pinned);
      el.classList.toggle('pinned', cardData.pinned);
      el.dataset.pinned = cardData.pinned ? 'true' : 'false';
      pinBtn.title = cardData.pinned ? 'Unpin' : 'Pin';
    };
    actions.appendChild(pinBtn);

    header.appendChild(actions);
    el.appendChild(header);

    // Body
    var body = document.createElement('div');
    body.className = 'card-body';

    switch (cardData.card_type) {
      case 'table':
        renderTable(body, cardData);
        break;
      case 'plotly':
        renderPlotly(body, cardData);
        break;
      case 'image':
        renderImage(body, cardData);
        break;
      case 'markdown':
        renderMarkdown(body, cardData);
        break;
      case 'keyvalue':
        renderKeyValue(body, cardData);
        break;
      case 'form':
        renderForm(body, cardData);
        break;
      case 'section':
        el.remove();
        addSection(cardData.title || (cardData.preview && cardData.preview.title) || '');
        return;
      default:
        body.textContent = JSON.stringify(cardData.preview);
    }

    el.appendChild(body);

    // Controls bar for hybrid data+controls cards (table/chart with controls)
    if (cardData.preview && cardData.preview.controls && cardData.preview.controls.length > 0
        && cardData.card_type !== 'form') {
      var controlsBar = document.createElement('div');
      controlsBar.className = 'card-controls-bar';
      renderFormFields(controlsBar, cardData.preview.controls);
      el.appendChild(controlsBar);
    }

    // Waiting card: response UI
    if (cardData.response_requested) {
      el.classList.add('waiting');
      var responseUI = buildResponseUI(cardData, el);
      el.appendChild(responseUI);
      // Update agent status and send browser notification
      updateAgentStatus('Waiting for your response');
      notifyDecisionCard(cardData);
    }

    // Provenance
    if (cardData.provenance) {
      var prov = document.createElement('div');
      prov.className = 'card-provenance';
      var parts = [];
      if (cardData.provenance.source) parts.push(cardData.provenance.source);
      if (cardData.provenance.dataset) parts.push(cardData.provenance.dataset);
      if (cardData.provenance.timestamp) {
        parts.push(new Date(cardData.provenance.timestamp).toLocaleString());
      }
      prov.textContent = parts.join(' \u00b7 ');
      if (parts.length > 0) el.appendChild(prov);
    }

    feed.appendChild(el);

    // Apply run filter to the new card
    if (state.activeRunFilter) {
      var cardRun = cardData.run_id || '';
      if (cardRun !== state.activeRunFilter && cardRun) {
        el.classList.add('hidden-by-filter');
      }
    }

    updateCardCount();
    scrollToBottom();
  }

  function copyCardContent(cardData, btn) {
    var text = '';
    if (cardData.card_type === 'markdown') {
      text = (cardData.preview && cardData.preview.text) || '';
    } else if (cardData.card_type === 'keyvalue') {
      var items = (cardData.preview && cardData.preview.items) || {};
      text = Object.keys(items).map(function(k) { return k + ': ' + items[k]; }).join('\n');
    } else if (cardData.card_type === 'table') {
      var p = cardData.preview;
      if (p && p.columns) {
        text = p.columns.join('\t') + '\n';
        (p.preview_rows || []).forEach(function(row) {
          text += row.map(function(v) { return v === null ? '' : String(v); }).join('\t') + '\n';
        });
      }
    } else if (cardData.card_type === 'plotly') {
      text = JSON.stringify(cardData.preview && cardData.preview.spec, null, 2);
    } else if (cardData.card_type === 'image') {
      // For images, copy the artifact URL so it can be opened/embedded
      text = cardData.artifact_id
        ? location.origin + '/api/artifact/' + cardData.artifact_id
        : '(no artifact)';
    } else if (cardData.card_type === 'form') {
      var fields = (cardData.preview && cardData.preview.fields) || [];
      text = fields.map(function(f) {
        return (f.label || f.name) + ': ' + (f.default != null ? String(f.default) : '');
      }).join('\n');
    } else {
      text = JSON.stringify(cardData.preview, null, 2);
    }

    navigator.clipboard.writeText(text).then(function() {
      btn.classList.add('copied');
      btn.innerHTML = '&#10003;';
      showToast('Copied to clipboard');
      setTimeout(function() {
        btn.classList.remove('copied');
        btn.innerHTML = '&#128203;';
      }, 1500);
    }).catch(function() {});
  }

  function showToast(msg) {
    copyToastEl.textContent = msg;
    copyToastEl.classList.add('visible');
    setTimeout(function() {
      copyToastEl.classList.remove('visible');
    }, 1500);
  }

  // ================================================================
  // TABLE RENDERING — headers, rows, sorting, paging, row detail
  // ================================================================
  function mapDtypeLabel(dtype) {
    if (!dtype) return '';
    var d = dtype.toLowerCase();
    if (d.match(/^int/)) return 'int';
    if (d.match(/^float|^double|^decimal|^numeric/)) return 'float';
    if (d.match(/^bool/)) return 'bool';
    if (d.match(/^date|^time|^timestamp/)) return 'date';
    if (d.match(/^varchar|^text|^string|^utf|^object/)) return 'str';
    return dtype.split(/[^a-zA-Z]/)[0].toLowerCase().substring(0, 5);
  }

  function renderTable(container, cardData) {
    var preview = cardData.preview;
    if (!preview || !preview.columns) return;

    // Shared state for this table
    var sortState = { col: null, asc: true };
    var pagerState = { offset: 0, limit: 50 };
    var searchState = { text: '' };
    var shape = preview.shape || [0, 0];
    var totalRowsRef = { value: shape[0] };
    var rowInfoEl = document.createElement('span');
    var pagerEl = { current: null };

    function updateRowInfo() {
      var total = totalRowsRef.value;
      var start = total > 0 ? pagerState.offset + 1 : 0;
      var end = Math.min(pagerState.offset + pagerState.limit, total);
      var text = shape[1] + ' columns \u00b7 ' + total.toLocaleString() + ' rows';
      if (searchState.text) text += ' (filtered)';
      if (total > 0 && (start > 1 || end < total)) text += ' (showing ' + start + '\u2013' + end + ')';
      rowInfoEl.textContent = text;
    }

    // --- Toolbar (search + export) ---
    var toolbar = document.createElement('div');
    toolbar.className = 'table-toolbar';

    if (cardData.artifact_id) {
      var searchInput = document.createElement('input');
      searchInput.type = 'text';
      searchInput.className = 'table-search';
      searchInput.placeholder = 'Search rows...';
      var debounceTimer = null;
      searchInput.oninput = function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(function() {
          searchState.text = searchInput.value;
          pagerState.offset = 0;
          reloadTable(cardData.artifact_id, pagerState, sortState, searchState, wrapper, preview.columns, preview.dtypes, totalRowsRef, rowInfoEl, pagerEl, updateRowInfo);
        }, 300);
      };
      toolbar.appendChild(searchInput);

      var exportCsvBtn = document.createElement('button');
      exportCsvBtn.className = 'export-btn';
      exportCsvBtn.textContent = 'Export CSV';
      exportCsvBtn.onclick = function() {
        var url = '/api/table/' + cardData.artifact_id + '/export?format=csv';
        if (sortState.col) url += '&sort=' + encodeURIComponent(sortState.col) + '&asc=' + sortState.asc;
        if (searchState.text) url += '&search=' + encodeURIComponent(searchState.text);
        window.location = url;
      };
      toolbar.appendChild(exportCsvBtn);

      var copyTsvBtn = document.createElement('button');
      copyTsvBtn.className = 'export-btn';
      copyTsvBtn.textContent = 'Copy TSV';
      copyTsvBtn.onclick = function() {
        var tbody = wrapper.querySelector('tbody');
        var headerCells = wrapper.querySelectorAll('thead th:not(.select-col)');
        var headers = [];
        headerCells.forEach(function(th) {
          // Get just the column name text (not the sort indicator or type badge)
          headers.push(th.firstChild.textContent);
        });
        var lines = [headers.join('\t')];
        var bodyRows = tbody.querySelectorAll('tr');
        bodyRows.forEach(function(tr) {
          var cells = [];
          tr.querySelectorAll('td:not(.select-col)').forEach(function(td) { cells.push(td.textContent); });
          lines.push(cells.join('\t'));
        });
        navigator.clipboard.writeText(lines.join('\n')).then(function() {
          showToast('Copied TSV to clipboard');
        }).catch(function() {});
      };
      toolbar.appendChild(copyTsvBtn);
    }

    container.appendChild(toolbar);

    // --- Table ---
    var wrapper = document.createElement('div');
    wrapper.className = 'table-wrapper';

    var table = document.createElement('table');
    var thead = document.createElement('thead');
    var headerRow = document.createElement('tr');

    // Add select-all checkbox column for all table cards
    var selectAllTh = document.createElement('th');
    selectAllTh.className = 'select-col';
    var selectAllCb = document.createElement('input');
    selectAllCb.type = 'checkbox';
    selectAllCb.title = 'Select all on this page';
    selectAllCb.onchange = function() {
      var cbs = wrapper.querySelectorAll('tbody .select-col input[type="checkbox"]');
      cbs.forEach(function(cb) {
        cb.checked = selectAllCb.checked;
        // Fire the onchange to update selection state
        if (cb.onchange) cb.onchange();
      });
    };
    selectAllTh.appendChild(selectAllCb);
    headerRow.appendChild(selectAllTh);

    preview.columns.forEach(function(col) {
      var th = document.createElement('th');
      var isNumeric = false;
      if (preview.dtypes) {
        var dtype = preview.dtypes[col] || '';
        if (dtype.match(/int|float|num/i)) {
          th.style.textAlign = 'right';
          isNumeric = true;
        }
      }

      var label = document.createTextNode(col);
      th.appendChild(label);

      // Type badge
      if (preview.dtypes && preview.dtypes[col]) {
        var badge = document.createElement('span');
        badge.className = 'type-badge';
        badge.textContent = mapDtypeLabel(preview.dtypes[col]);
        th.appendChild(badge);
      }

      var indicator = document.createElement('span');
      indicator.className = 'sort-indicator';
      indicator.textContent = '\u2195';
      th.appendChild(indicator);

      if (cardData.artifact_id) {
        th.onclick = function() {
          if (sortState.col === col) {
            sortState.asc = !sortState.asc;
          } else {
            sortState.col = col;
            sortState.asc = true;
          }
          headerRow.querySelectorAll('.sort-indicator').forEach(function(ind) {
            ind.classList.remove('active');
            ind.textContent = '\u2195';
          });
          indicator.classList.add('active');
          indicator.textContent = sortState.asc ? '\u25b2' : '\u25bc';
          pagerState.offset = 0;
          reloadTable(cardData.artifact_id, pagerState, sortState, searchState, wrapper, preview.columns, preview.dtypes, totalRowsRef, rowInfoEl, pagerEl, updateRowInfo);
        };
      }

      headerRow.appendChild(th);
    });

    thead.appendChild(headerRow);
    table.appendChild(thead);

    var tbody = document.createElement('tbody');
    var rows = preview.preview_rows || [];
    renderTableRows(tbody, rows, preview.columns, preview.dtypes, cardData);

    table.appendChild(tbody);
    wrapper.appendChild(table);

    // --- Table info & pagination ---
    var totalRows = totalRowsRef.value;
    var previewCount = rows.length;

    var info = document.createElement('div');
    info.className = 'table-info';
    info.appendChild(rowInfoEl);

    if (totalRows > previewCount && cardData.artifact_id) {
      // Initial view has only preview rows — load the full first page immediately
      reloadTable(cardData.artifact_id, pagerState, sortState, searchState, wrapper, preview.columns, preview.dtypes, totalRowsRef, rowInfoEl, pagerEl, updateRowInfo);
      var pager = createPager(cardData.artifact_id, totalRowsRef, preview.columns, preview.dtypes, wrapper, rowInfoEl, pagerState, sortState, searchState, cardData, updateRowInfo);
      pagerEl.current = pager;
      info.appendChild(pager);
    } else {
      // Small table — preview is the full data
      rowInfoEl.textContent = shape[1] + ' columns \u00b7 ' + totalRows.toLocaleString() + ' rows';
    }

    container.appendChild(wrapper);
    container.appendChild(info);
  }

  function reloadTable(artifactId, pagerState, sortState, searchState, wrapper, columns, dtypes, totalRowsRef, rowInfoEl, pagerEl, updateRowInfo) {
    var url = '/api/table/' + artifactId + '?offset=' + pagerState.offset + '&limit=' + pagerState.limit;
    if (sortState && sortState.col) {
      url += '&sort=' + encodeURIComponent(sortState.col) + '&asc=' + sortState.asc;
    }
    if (searchState && searchState.text) {
      url += '&search=' + encodeURIComponent(searchState.text);
    }
    fetch(url)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        totalRowsRef.value = data.total_rows;
        var tbody = wrapper.querySelector('tbody');
        // Find the parent card to get cardData for row click events
        var cardEl = wrapper.closest('.card');
        var cardData = null;
        if (cardEl) {
          var cardId = cardEl.dataset.cardId;
          cardData = state.cards.find(function(c) { return c.card_id === cardId; });
        }
        renderTableRows(tbody, data.rows, columns, dtypes, cardData, pagerState.offset);
        if (updateRowInfo) updateRowInfo();

        // Rebuild pager if needed
        if (pagerEl && pagerEl.current) {
          var parent = pagerEl.current.parentNode;
          parent.removeChild(pagerEl.current);
          var newPager = createPager(artifactId, totalRowsRef, columns, dtypes, wrapper, rowInfoEl, pagerState, sortState, searchState, cardData, updateRowInfo);
          pagerEl.current = newPager;
          parent.appendChild(newPager);
        } else if (data.total_rows > pagerState.limit) {
          var infoDiv = rowInfoEl.parentNode;
          var newPager = createPager(artifactId, totalRowsRef, columns, dtypes, wrapper, rowInfoEl, pagerState, sortState, searchState, cardData, updateRowInfo);
          pagerEl.current = newPager;
          infoDiv.appendChild(newPager);
        }
      });
  }

  function renderTableRows(tbody, rows, columns, dtypes, cardData, pageOffset) {
    tbody.innerHTML = '';
    var cardId = cardData ? cardData.card_id : null;
    pageOffset = pageOffset || 0;
    // Ensure selection set exists for this card
    if (cardId && !state.selections[cardId]) {
      state.selections[cardId] = new Set();
    }
    rows.forEach(function(row, rowIdx) {
      var tr = document.createElement('tr');
      var absIdx = pageOffset + rowIdx;
      // Add selection checkbox for all table cards
      var selTd = document.createElement('td');
      selTd.className = 'select-col';
      var cb = document.createElement('input');
      cb.type = 'checkbox';
      if (cardId && state.selections[cardId] && state.selections[cardId].has(absIdx)) {
        cb.checked = true;
      }
      cb.onclick = function(e) { e.stopPropagation(); };
      cb.onchange = function() {
        if (!cardId) return;
        if (!state.selections[cardId]) state.selections[cardId] = new Set();
        if (cb.checked) {
          state.selections[cardId].add(absIdx);
        } else {
          state.selections[cardId].delete(absIdx);
        }
        updateSelectionBadge(cardId);
        sendSelectionEvent(cardId);
      };
      selTd.appendChild(cb);
      tr.appendChild(selTd);
      row.forEach(function(val, i) {
        var td = document.createElement('td');
        td.textContent = val === null ? '\u2014' : String(val);
        if (dtypes) {
          var dtype = dtypes[columns[i]] || '';
          if (dtype.match(/int|float|num/i)) {
            td.style.textAlign = 'right';
          }
        }
        tr.appendChild(td);
      });
      // Row click → detail panel + WebSocket event
      tr.onclick = function() {
        var rowObj = {};
        columns.forEach(function(col, i) { rowObj[col] = row[i]; });
        showRowDetail(columns, row, dtypes, cardData);
        // Fire WebSocket event
        if (cardData && state.ws && state.connected) {
          state.ws.send(JSON.stringify({
            type: 'vitrine.event',
            event_type: 'row_click',
            card_id: cardData.card_id,
            payload: { row_index: rowIdx, row: rowObj },
          }));
        }
      };
      tbody.appendChild(tr);
    });
  }

  function showRowDetail(columns, row, dtypes, cardData) {
    // Remove any existing detail panel
    closeRowDetail();

    var overlay = document.createElement('div');
    overlay.className = 'row-detail-overlay';
    overlay.id = 'row-detail-overlay';
    overlay.onclick = function(e) {
      if (e.target === overlay) closeRowDetail();
    };

    var panel = document.createElement('div');
    panel.className = 'row-detail-panel';

    var header = document.createElement('div');
    header.className = 'row-detail-header';
    var headerTitle = document.createElement('span');
    headerTitle.textContent = (cardData && cardData.title ? cardData.title + ' \u2014 ' : '') + 'Row Detail';
    header.appendChild(headerTitle);
    var closeBtn = document.createElement('button');
    closeBtn.className = 'row-detail-close';
    closeBtn.innerHTML = '&times;';
    closeBtn.onclick = closeRowDetail;
    header.appendChild(closeBtn);
    panel.appendChild(header);

    var body = document.createElement('div');
    body.className = 'row-detail-body';

    var dl = document.createElement('div');
    dl.className = 'kv-list';

    columns.forEach(function(col, i) {
      var keyEl = document.createElement('div');
      keyEl.className = 'kv-key';
      var keyText = col;
      if (dtypes && dtypes[col]) {
        keyText += ' ';
        var badge = document.createElement('span');
        badge.className = 'type-badge';
        badge.textContent = mapDtypeLabel(dtypes[col]);
        keyEl.textContent = col + ' ';
        keyEl.appendChild(badge);
      } else {
        keyEl.textContent = col;
      }

      var valEl = document.createElement('div');
      valEl.className = 'kv-value';
      valEl.textContent = row[i] === null ? '\u2014' : String(row[i]);
      valEl.style.wordBreak = 'break-all';

      dl.appendChild(keyEl);
      dl.appendChild(valEl);
    });

    body.appendChild(dl);
    panel.appendChild(body);
    overlay.appendChild(panel);
    document.body.appendChild(overlay);

    // ESC to close
    document.addEventListener('keydown', _rowDetailEsc);
  }

  function _rowDetailEsc(e) {
    if (e.key === 'Escape') closeRowDetail();
  }

  function closeRowDetail() {
    var overlay = document.getElementById('row-detail-overlay');
    if (overlay) overlay.remove();
    document.removeEventListener('keydown', _rowDetailEsc);
  }

  function createPager(artifactId, totalRowsRef, columns, dtypes, wrapper, rowInfoEl, pagerState, sortState, searchState, cardData, updateRowInfo) {
    var limit = pagerState.limit;

    var pager = document.createElement('div');
    pager.className = 'table-pager';

    var prevBtn = document.createElement('button');
    prevBtn.textContent = '\u2190 Prev';
    prevBtn.disabled = true;

    var pageInfo = document.createElement('span');

    var nextBtn = document.createElement('button');
    nextBtn.textContent = 'Next \u2192';

    function updatePage() {
      var total = totalRowsRef.value;
      var start = total > 0 ? pagerState.offset + 1 : 0;
      var end = Math.min(pagerState.offset + limit, total);
      pageInfo.textContent = start + '\u2013' + end + ' of ' + total.toLocaleString();
      prevBtn.disabled = pagerState.offset === 0;
      nextBtn.disabled = pagerState.offset + limit >= total;
      if (updateRowInfo) updateRowInfo();
    }

    function loadPage() {
      var url = '/api/table/' + artifactId + '?offset=' + pagerState.offset + '&limit=' + limit;
      if (sortState && sortState.col) {
        url += '&sort=' + encodeURIComponent(sortState.col) + '&asc=' + sortState.asc;
      }
      if (searchState && searchState.text) {
        url += '&search=' + encodeURIComponent(searchState.text);
      }
      fetch(url)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          totalRowsRef.value = data.total_rows;
          var tbody = wrapper.querySelector('tbody');
          renderTableRows(tbody, data.rows, columns, dtypes, cardData, pagerState.offset);
          updatePage();
        });
    }

    prevBtn.onclick = function() {
      pagerState.offset = Math.max(0, pagerState.offset - limit);
      loadPage();
    };

    nextBtn.onclick = function() {
      pagerState.offset = pagerState.offset + limit;
      loadPage();
    };

    pager.appendChild(prevBtn);
    pager.appendChild(pageInfo);
    pager.appendChild(nextBtn);
    updatePage();

    return pager;
  }

  // ================================================================
  // CONTENT RENDERERS — markdown, key-value, plotly, image
  // ================================================================
  function renderMarkdown(container, cardData) {
    var text = (cardData.preview && cardData.preview.text) || '';
    container.className += ' markdown-body';

    if (window.marked) {
      container.innerHTML = window.marked.parse(text);
    } else {
      container.innerHTML = basicMarkdown(text);
      loadMarked(function() {
        container.innerHTML = window.marked.parse(text);
      });
    }
  }

  function basicMarkdown(text) {
    return text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/^### (.+)$/gm, '<h3>$1</h3>')
      .replace(/^## (.+)$/gm, '<h2>$1</h2>')
      .replace(/^# (.+)$/gm, '<h1>$1</h1>')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      .replace(/`([^`]+)`/g, '<code>$1</code>')
      .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
      .replace(/\n\n/g, '</p><p>')
      .replace(/\n/g, '<br>')
      .replace(/^/, '<p>')
      .replace(/$/, '</p>');
  }

  function loadMarked(callback) {
    if (state.markedLoaded) return;
    state.markedLoaded = true;

    var script = document.createElement('script');
    script.src = '/static/vendor/marked.min.js';
    script.onload = function() {
      if (window.marked) {
        window.marked.setOptions({ breaks: true, gfm: true });
        if (callback) callback();
      }
    };
    script.onerror = function() {
      state.markedLoaded = false;
    };
    document.head.appendChild(script);
  }

  function renderKeyValue(container, cardData) {
    var items = (cardData.preview && cardData.preview.items) || {};
    var dl = document.createElement('div');
    dl.className = 'kv-list';

    Object.keys(items).forEach(function(key) {
      var keyEl = document.createElement('div');
      keyEl.className = 'kv-key';
      keyEl.textContent = key;

      var valEl = document.createElement('div');
      valEl.className = 'kv-value';
      valEl.textContent = items[key];

      dl.appendChild(keyEl);
      dl.appendChild(valEl);
    });

    container.appendChild(dl);
  }

  function renderPlotly(container, cardData) {
    var spec = cardData.preview && cardData.preview.spec;
    if (!spec) {
      container.textContent = 'No chart data';
      return;
    }

    var plotDiv = document.createElement('div');
    plotDiv.className = 'plotly-container';
    plotDiv.id = 'plotly-' + cardData.card_id;
    container.appendChild(plotDiv);

    function doRender() {
      var data = spec.data || [];
      var layout = Object.assign({}, spec.layout || {}, {
        autosize: true,
        margin: { l: 50, r: 30, t: 40, b: 50 },
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent',
        font: { color: getComputedStyle(document.documentElement).getPropertyValue('--text').trim() },
      });
      var config = { responsive: true, displayModeBar: true, displaylogo: false };

      window.Plotly.newPlot(plotDiv, data, layout, config).then(function() {
        // Attach point selection event
        plotDiv.on('plotly_selected', function(eventData) {
          if (eventData && state.ws && state.connected) {
            var points = (eventData.points || []).map(function(pt) {
              return { x: pt.x, y: pt.y, pointIndex: pt.pointIndex, curveNumber: pt.curveNumber };
            });
            var indices = points.map(function(pt) { return pt.pointIndex; });
            state.ws.send(JSON.stringify({
              type: 'vitrine.event',
              event_type: 'selection',
              card_id: cardData.card_id,
              payload: { selected_indices: indices, points: points },
            }));
          }
        });

        plotDiv.on('plotly_click', function(eventData) {
          if (eventData && state.ws && state.connected) {
            var points = (eventData.points || []).map(function(pt) {
              return { x: pt.x, y: pt.y, pointIndex: pt.pointIndex, curveNumber: pt.curveNumber };
            });
            state.ws.send(JSON.stringify({
              type: 'vitrine.event',
              event_type: 'point_click',
              card_id: cardData.card_id,
              payload: { points: points },
            }));
          }
        });
      });
    }

    if (window.Plotly) {
      doRender();
    } else {
      // Show loading indicator
      var loading = document.createElement('div');
      loading.className = 'chart-loading';
      loading.textContent = 'Loading chart library...';
      plotDiv.appendChild(loading);

      loadPlotly(function() {
        plotDiv.removeChild(loading);
        doRender();
      });
    }
  }

  function loadPlotly(callback) {
    if (window.Plotly) {
      if (callback) callback();
      return;
    }

    // Queue callbacks if already loading
    if (state.plotlyLoaded) {
      state.plotlyCallbacks.push(callback);
      return;
    }
    state.plotlyLoaded = true;
    state.plotlyCallbacks.push(callback);

    var script = document.createElement('script');
    script.src = '/static/vendor/plotly.min.js';
    script.onload = function() {
      var cbs = state.plotlyCallbacks;
      state.plotlyCallbacks = [];
      cbs.forEach(function(cb) { if (cb) cb(); });
    };
    script.onerror = function() {
      state.plotlyLoaded = false;
      var cbs = state.plotlyCallbacks;
      state.plotlyCallbacks = [];
      cbs.forEach(function(cb) {
        // Attempt fallback: render as static image if artifact exists
      });
    };
    document.head.appendChild(script);
  }

  // Resize Plotly charts on window resize
  window.addEventListener('resize', function() {
    if (!window.Plotly) return;
    var plots = document.querySelectorAll('.plotly-container .js-plotly-plot');
    plots.forEach(function(plot) {
      window.Plotly.Plots.resize(plot);
    });
  });

  // Re-color Plotly charts on theme change
  var _origThemeToggle = themeToggleEl.onclick;
  themeToggleEl.onclick = function() {
    _origThemeToggle.call(this);
    if (!window.Plotly) return;
    var textColor = getComputedStyle(document.documentElement).getPropertyValue('--text').trim();
    var plots = document.querySelectorAll('.plotly-container .js-plotly-plot');
    plots.forEach(function(plot) {
      window.Plotly.relayout(plot, {
        'paper_bgcolor': 'transparent',
        'plot_bgcolor': 'transparent',
        'font.color': textColor,
      });
    });
  };

  function renderImage(container, cardData) {
    var preview = cardData.preview || {};
    var imgContainer = document.createElement('div');
    imgContainer.className = 'image-container';

    var img = document.createElement('img');

    if (preview.data && preview.format === 'svg') {
      img.src = 'data:image/svg+xml;base64,' + preview.data;
    } else if (preview.data && preview.format === 'png') {
      img.src = 'data:image/png;base64,' + preview.data;
    } else if (cardData.artifact_id) {
      // Fall back to artifact endpoint
      img.src = '/api/artifact/' + cardData.artifact_id;
    } else {
      container.textContent = 'No image data';
      return;
    }

    img.alt = cardData.title || 'Figure';
    img.style.maxWidth = '100%';
    imgContainer.appendChild(img);
    container.appendChild(imgContainer);
  }

  // ================================================================
  // SELECTION TRACKING
  // ================================================================
  function sendSelectionEvent(cardId) {
    if (!state.ws || !state.connected) return;
    var sel = state.selections[cardId];
    if (!sel) return;
    state.ws.send(JSON.stringify({
      type: 'vitrine.event',
      event_type: 'selection',
      card_id: cardId,
      payload: { selected_indices: Array.from(sel).sort(function(a, b) { return a - b; }) },
    }));
  }

  function updateSelectionBadge(cardId) {
    var cardEl = document.getElementById('card-' + cardId);
    if (!cardEl) return;
    var header = cardEl.querySelector('.card-header');
    if (!header) return;
    var badge = header.querySelector('.selection-badge');
    var sel = state.selections[cardId];
    var count = sel ? sel.size : 0;
    if (count > 0) {
      if (!badge) {
        badge = document.createElement('span');
        badge.className = 'selection-badge';
        // Insert before card-actions
        var actions = header.querySelector('.card-actions');
        if (actions) {
          header.insertBefore(badge, actions);
        } else {
          header.appendChild(badge);
        }
      }
      badge.textContent = count + ' selected';
    } else if (badge) {
      badge.remove();
    }
  }

  // ================================================================
  // FORM FIELDS — render, collect values, freeze confirmed state
  // ================================================================
  function renderForm(container, cardData) {
    var preview = cardData.preview;
    if (!preview || !preview.fields) return;
    renderFormFields(container, preview.fields);
  }

  function renderFormFields(container, fields) {
    var wrapper = document.createElement('div');
    wrapper.className = 'form-fields';

    fields.forEach(function(field) {
      var fieldEl = document.createElement('div');
      fieldEl.className = 'form-field';
      fieldEl.dataset.fieldName = field.name;
      fieldEl.dataset.fieldType = field.type;

      switch (field.type) {
        case 'dropdown':
          renderDropdownField(fieldEl, field);
          break;
        case 'multiselect':
          renderMultiSelectField(fieldEl, field);
          break;
        case 'slider':
          renderSliderField(fieldEl, field);
          break;
        case 'range_slider':
          renderRangeSliderField(fieldEl, field);
          break;
        case 'checkbox':
          renderCheckboxField(fieldEl, field);
          break;
        case 'toggle':
          renderToggleField(fieldEl, field);
          break;
        case 'radio':
          renderRadioField(fieldEl, field);
          break;
        case 'text':
          renderTextField(fieldEl, field);
          break;
        case 'date_range':
          renderDateRangeField(fieldEl, field);
          break;
        case 'number':
          renderNumberField(fieldEl, field);
          break;
        default:
          fieldEl.textContent = 'Unknown field type: ' + field.type;
      }

      wrapper.appendChild(fieldEl);
    });

    container.appendChild(wrapper);
  }

  function renderDropdownField(container, field) {
    if (field.label) {
      var label = document.createElement('div');
      label.className = 'form-field-label';
      label.textContent = field.label;
      container.appendChild(label);
    }

    var options = Array.isArray(field.options) ? field.options.map(function(opt) { return String(opt); }) : [];
    var defaultValue = field.default != null ? String(field.default) : '';
    var currentValue = '';
    if (options.length > 0) {
      currentValue = options.indexOf(defaultValue) !== -1 ? defaultValue : options[0];
    }

    var wrap = document.createElement('div');
    wrap.className = 'form-select';

    var hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.className = 'form-hidden-input';
    hiddenInput.dataset.fieldInput = field.name;
    hiddenInput.value = currentValue;
    wrap.appendChild(hiddenInput);

    var trigger = document.createElement('button');
    trigger.type = 'button';
    trigger.className = 'form-select-trigger';

    var triggerValue = document.createElement('span');
    triggerValue.className = 'form-select-value';
    trigger.appendChild(triggerValue);

    var arrow = document.createElement('span');
    arrow.className = 'dd-arrow';
    arrow.innerHTML = '&#9662;';
    trigger.appendChild(arrow);
    wrap.appendChild(trigger);

    var panel = document.createElement('div');
    panel.className = 'form-select-panel';
    panel.style.display = 'none';
    wrap.appendChild(panel);

    function syncTrigger() {
      var val = hiddenInput.value || '';
      triggerValue.textContent = val || 'Select option';
      triggerValue.classList.toggle('placeholder', !val);
      var btns = panel.querySelectorAll('.form-select-option');
      btns.forEach(function(btn) {
        btn.classList.toggle('selected', btn.dataset.value === val);
      });
    }

    if (options.length === 0) {
      var empty = document.createElement('div');
      empty.className = 'form-select-empty';
      empty.textContent = 'No options';
      panel.appendChild(empty);
    } else {
      options.forEach(function(opt) {
        var optionBtn = document.createElement('button');
        optionBtn.type = 'button';
        optionBtn.className = 'form-select-option';
        optionBtn.textContent = opt;
        optionBtn.dataset.value = opt;
        optionBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          hiddenInput.value = opt;
          syncTrigger();
          closePanel();
        });
        panel.appendChild(optionBtn);
      });
    }

    var outsideListener = null;
    function openPanel() {
      panel.style.display = '';
      trigger.classList.add('open');
      setTimeout(function() {
        outsideListener = function(e) {
          if (!wrap.contains(e.target)) closePanel();
        };
        document.addEventListener('mousedown', outsideListener);
      }, 0);
    }

    function closePanel() {
      panel.style.display = 'none';
      trigger.classList.remove('open');
      if (outsideListener) {
        document.removeEventListener('mousedown', outsideListener);
        outsideListener = null;
      }
    }

    trigger.addEventListener('click', function(e) {
      e.stopPropagation();
      if (panel.style.display === 'none') {
        openPanel();
      } else {
        closePanel();
      }
    });

    trigger.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        e.preventDefault();
        closePanel();
      }
    });

    syncTrigger();
    container.appendChild(wrap);
  }

  function toIsoDate(dateObj) {
    if (!(dateObj instanceof Date) || isNaN(dateObj.getTime())) return '';
    var y = String(dateObj.getFullYear());
    var m = String(dateObj.getMonth() + 1).padStart(2, '0');
    var d = String(dateObj.getDate()).padStart(2, '0');
    return y + '-' + m + '-' + d;
  }

  function parseIsoDate(isoStr) {
    if (!isoStr || !/^\d{4}-\d{2}-\d{2}$/.test(isoStr)) return null;
    var parts = isoStr.split('-');
    return new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
  }

  function formatIsoDate(isoStr) {
    var parsed = parseIsoDate(isoStr);
    if (!parsed) return '';
    return parsed.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
  }

  function createDatePicker(fieldName, rangeEnd, initialValue) {
    var picker = document.createElement('div');
    picker.className = 'form-date-picker';

    var hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.className = 'form-hidden-input';
    hiddenInput.dataset.fieldInput = fieldName;
    hiddenInput.dataset.rangeEnd = rangeEnd;
    hiddenInput.value = initialValue || '';
    picker.appendChild(hiddenInput);

    var trigger = document.createElement('button');
    trigger.type = 'button';
    trigger.className = 'form-date-trigger';

    var valueEl = document.createElement('span');
    valueEl.className = 'form-date-value';
    trigger.appendChild(valueEl);

    var arrow = document.createElement('span');
    arrow.className = 'dd-arrow';
    arrow.innerHTML = '&#9662;';
    trigger.appendChild(arrow);
    picker.appendChild(trigger);

    var panel = document.createElement('div');
    panel.className = 'form-calendar-panel';
    panel.style.display = 'none';

    var header = document.createElement('div');
    header.className = 'form-calendar-header';

    var prevBtn = document.createElement('button');
    prevBtn.type = 'button';
    prevBtn.className = 'form-calendar-nav-btn';
    prevBtn.innerHTML = '&#9664;';

    var monthLabel = document.createElement('div');
    monthLabel.className = 'form-calendar-month';

    var nextBtn = document.createElement('button');
    nextBtn.type = 'button';
    nextBtn.className = 'form-calendar-nav-btn';
    nextBtn.innerHTML = '&#9654;';

    header.appendChild(prevBtn);
    header.appendChild(monthLabel);
    header.appendChild(nextBtn);
    panel.appendChild(header);

    var weekdays = document.createElement('div');
    weekdays.className = 'form-calendar-weekdays';
    ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'].forEach(function(label) {
      var weekday = document.createElement('div');
      weekday.className = 'form-calendar-weekday';
      weekday.textContent = label;
      weekdays.appendChild(weekday);
    });
    panel.appendChild(weekdays);

    var daysGrid = document.createElement('div');
    daysGrid.className = 'form-calendar-days';
    panel.appendChild(daysGrid);
    picker.appendChild(panel);

    var selectedDate = parseIsoDate(hiddenInput.value);
    var visibleMonth = selectedDate || new Date();
    visibleMonth = new Date(visibleMonth.getFullYear(), visibleMonth.getMonth(), 1);

    function updateValueLabel() {
      var text = formatIsoDate(hiddenInput.value);
      valueEl.textContent = text || 'Select date';
      valueEl.classList.toggle('placeholder', !text);
    }

    function renderCalendar() {
      monthLabel.textContent = visibleMonth.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
      daysGrid.innerHTML = '';

      var firstOfMonth = new Date(visibleMonth.getFullYear(), visibleMonth.getMonth(), 1);
      var gridStart = new Date(firstOfMonth);
      gridStart.setDate(1 - firstOfMonth.getDay());
      var todayIso = toIsoDate(new Date());
      var selectedIso = hiddenInput.value || '';

      for (var i = 0; i < 42; i++) {
        var cellDate = new Date(gridStart);
        cellDate.setDate(gridStart.getDate() + i);
        var iso = toIsoDate(cellDate);
        var dayBtn = document.createElement('button');
        dayBtn.type = 'button';
        dayBtn.className = 'form-calendar-day';
        dayBtn.textContent = String(cellDate.getDate());
        dayBtn.dataset.value = iso;

        if (cellDate.getMonth() !== visibleMonth.getMonth()) {
          dayBtn.classList.add('other-month');
        }
        if (iso === todayIso) {
          dayBtn.classList.add('today');
        }
        if (iso === selectedIso) {
          dayBtn.classList.add('selected');
        }

        dayBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          hiddenInput.value = this.dataset.value || '';
          updateValueLabel();
          visibleMonth = parseIsoDate(hiddenInput.value) || visibleMonth;
          visibleMonth = new Date(visibleMonth.getFullYear(), visibleMonth.getMonth(), 1);
          closePanel();
        });

        daysGrid.appendChild(dayBtn);
      }
    }

    prevBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      visibleMonth = new Date(visibleMonth.getFullYear(), visibleMonth.getMonth() - 1, 1);
      renderCalendar();
    });

    nextBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      visibleMonth = new Date(visibleMonth.getFullYear(), visibleMonth.getMonth() + 1, 1);
      renderCalendar();
    });

    var outsideListener = null;
    function openPanel() {
      var selected = parseIsoDate(hiddenInput.value);
      if (selected) {
        visibleMonth = new Date(selected.getFullYear(), selected.getMonth(), 1);
      }
      renderCalendar();
      panel.style.display = '';
      trigger.classList.add('open');
      setTimeout(function() {
        outsideListener = function(e) {
          if (!picker.contains(e.target)) closePanel();
        };
        document.addEventListener('mousedown', outsideListener);
      }, 0);
    }

    function closePanel() {
      panel.style.display = 'none';
      trigger.classList.remove('open');
      if (outsideListener) {
        document.removeEventListener('mousedown', outsideListener);
        outsideListener = null;
      }
    }

    trigger.addEventListener('click', function(e) {
      e.stopPropagation();
      if (panel.style.display === 'none') {
        openPanel();
      } else {
        closePanel();
      }
    });

    trigger.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        e.preventDefault();
        closePanel();
      }
      if (e.key === 'Backspace' || e.key === 'Delete') {
        e.preventDefault();
        hiddenInput.value = '';
        updateValueLabel();
      }
    });

    updateValueLabel();
    return picker;
  }

  function renderMultiSelectField(container, field) {
    if (field.label) {
      var label = document.createElement('div');
      label.className = 'form-field-label';
      label.textContent = field.label;
      container.appendChild(label);
    }
    var optionsDiv = document.createElement('div');
    optionsDiv.className = 'form-multiselect-options';
    var defaults = field.default || [];
    (field.options || []).forEach(function(opt) {
      var optLabel = document.createElement('label');
      optLabel.className = 'form-multiselect-option';
      var cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = opt;
      cb.dataset.fieldInput = field.name;
      if (defaults.indexOf(opt) !== -1) cb.checked = true;
      optLabel.appendChild(cb);
      optLabel.appendChild(document.createTextNode(opt));
      optionsDiv.appendChild(optLabel);
    });
    container.appendChild(optionsDiv);
  }

  function renderSliderField(container, field) {
    if (field.label) {
      var label = document.createElement('div');
      label.className = 'form-field-label';
      label.textContent = field.label;
      container.appendChild(label);
    }
    var row = document.createElement('div');
    row.className = 'form-slider-row';
    var slider = document.createElement('input');
    slider.type = 'range';
    slider.min = field.min != null ? field.min : 0;
    slider.max = field.max != null ? field.max : 100;
    slider.step = field.step != null ? field.step : ((field.max - field.min) <= 1 ? 0.01 : 1);
    slider.value = field.default != null ? field.default : field.min;
    slider.dataset.fieldInput = field.name;
    var valueEl = document.createElement('span');
    valueEl.className = 'form-slider-value';
    valueEl.textContent = slider.value;
    slider.oninput = function() { valueEl.textContent = slider.value; };
    row.appendChild(slider);
    row.appendChild(valueEl);
    container.appendChild(row);
  }

  function renderRangeSliderField(container, field) {
    if (field.label) {
      var label = document.createElement('div');
      label.className = 'form-field-label';
      label.textContent = field.label;
      container.appendChild(label);
    }
    var row = document.createElement('div');
    row.className = 'form-range-slider-row';
    var defaults = field.default || [field.min, field.max];
    var step = field.step != null ? field.step : ((field.max - field.min) <= 1 ? 0.01 : 1);

    var sliderLow = document.createElement('input');
    sliderLow.type = 'range';
    sliderLow.min = field.min != null ? field.min : 0;
    sliderLow.max = field.max != null ? field.max : 100;
    sliderLow.step = step;
    sliderLow.value = defaults[0];
    sliderLow.dataset.fieldInput = field.name;
    sliderLow.dataset.rangeEnd = 'low';

    var sliderHigh = document.createElement('input');
    sliderHigh.type = 'range';
    sliderHigh.min = field.min != null ? field.min : 0;
    sliderHigh.max = field.max != null ? field.max : 100;
    sliderHigh.step = step;
    sliderHigh.value = defaults[1];
    sliderHigh.dataset.fieldInput = field.name;
    sliderHigh.dataset.rangeEnd = 'high';

    var valueEl = document.createElement('span');
    valueEl.className = 'form-range-value';
    valueEl.textContent = sliderLow.value + ' \u2013 ' + sliderHigh.value;

    function updateRange() {
      var lo = parseFloat(sliderLow.value);
      var hi = parseFloat(sliderHigh.value);
      if (lo > hi) { sliderLow.value = hi; lo = hi; }
      if (hi < lo) { sliderHigh.value = lo; hi = lo; }
      valueEl.textContent = lo + ' \u2013 ' + hi;
    }
    sliderLow.oninput = updateRange;
    sliderHigh.oninput = updateRange;

    row.appendChild(sliderLow);
    row.appendChild(valueEl);
    row.appendChild(sliderHigh);
    container.appendChild(row);
  }

  function renderCheckboxField(container, field) {
    var row = document.createElement('div');
    row.className = 'form-check-row';
    var cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = !!field.default;
    cb.dataset.fieldInput = field.name;
    cb.id = 'form-cb-' + field.name;
    row.appendChild(cb);
    if (field.label) {
      var label = document.createElement('label');
      label.className = 'form-check-label';
      label.htmlFor = cb.id;
      label.textContent = field.label;
      row.appendChild(label);
    }
    container.appendChild(row);
  }

  function renderToggleField(container, field) {
    var row = document.createElement('div');
    row.className = 'form-check-row';
    var toggle = document.createElement('label');
    toggle.className = 'form-toggle-switch';
    var input = document.createElement('input');
    input.type = 'checkbox';
    input.checked = !!field.default;
    input.dataset.fieldInput = field.name;
    var track = document.createElement('span');
    track.className = 'form-toggle-track';
    toggle.appendChild(input);
    toggle.appendChild(track);
    row.appendChild(toggle);
    if (field.label) {
      var label = document.createElement('span');
      label.className = 'form-check-label';
      label.textContent = field.label;
      row.appendChild(label);
    }
    container.appendChild(row);
  }

  function renderRadioField(container, field) {
    if (field.label) {
      var label = document.createElement('div');
      label.className = 'form-field-label';
      label.textContent = field.label;
      container.appendChild(label);
    }
    var optionsDiv = document.createElement('div');
    optionsDiv.className = 'form-radio-options';
    var groupName = 'radio-' + field.name + '-' + Math.random().toString(36).slice(2, 8);
    (field.options || []).forEach(function(opt) {
      var optLabel = document.createElement('label');
      optLabel.className = 'form-radio-option';
      var radio = document.createElement('input');
      radio.type = 'radio';
      radio.name = groupName;
      radio.value = opt;
      radio.dataset.fieldInput = field.name;
      if (field.default === opt) radio.checked = true;
      optLabel.appendChild(radio);
      optLabel.appendChild(document.createTextNode(opt));
      optionsDiv.appendChild(optLabel);
    });
    container.appendChild(optionsDiv);
  }

  function renderTextField(container, field) {
    if (field.label) {
      var label = document.createElement('div');
      label.className = 'form-field-label';
      label.textContent = field.label;
      container.appendChild(label);
    }
    var input = document.createElement('input');
    input.type = 'text';
    input.value = field.default || '';
    input.placeholder = field.placeholder || '';
    input.dataset.fieldInput = field.name;
    container.appendChild(input);
  }

  function renderDateRangeField(container, field) {
    if (field.label) {
      var label = document.createElement('div');
      label.className = 'form-field-label';
      label.textContent = field.label;
      container.appendChild(label);
    }
    var row = document.createElement('div');
    row.className = 'form-date-range-row';
    var defaults = field.default || ['', ''];
    var startPicker = createDatePicker(field.name, 'start', defaults[0] || '');

    var sep = document.createElement('span');
    sep.className = 'form-date-range-sep';
    sep.textContent = 'to';

    var endPicker = createDatePicker(field.name, 'end', defaults[1] || '');

    row.appendChild(startPicker);
    row.appendChild(sep);
    row.appendChild(endPicker);
    container.appendChild(row);
  }

  function renderNumberField(container, field) {
    if (field.label) {
      var label = document.createElement('div');
      label.className = 'form-field-label';
      label.textContent = field.label;
      container.appendChild(label);
    }
    var input = document.createElement('input');
    input.type = 'number';
    if (field.default != null) input.value = field.default;
    if (field.min != null) input.min = field.min;
    if (field.max != null) input.max = field.max;
    if (field.step != null) input.step = field.step;
    input.dataset.fieldInput = field.name;
    container.appendChild(input);
  }

  function collectFormValues(cardEl) {
    var values = {};
    var fields = cardEl.querySelectorAll('.form-field');
    fields.forEach(function(fieldEl) {
      var name = fieldEl.dataset.fieldName;
      var type = fieldEl.dataset.fieldType;

      switch (type) {
        case 'dropdown': {
          var hidden = fieldEl.querySelector('input.form-hidden-input[data-field-input]');
          if (hidden) {
            values[name] = hidden.value;
            break;
          }
          var sel = fieldEl.querySelector('select');
          if (sel) values[name] = sel.value;
          break;
        }
        case 'multiselect': {
          var checked = fieldEl.querySelectorAll('input[type="checkbox"]:checked');
          values[name] = Array.prototype.map.call(checked, function(cb) { return cb.value; });
          break;
        }
        case 'slider': {
          var sl = fieldEl.querySelector('input[type="range"]');
          if (sl) values[name] = parseFloat(sl.value);
          break;
        }
        case 'range_slider': {
          var lo = fieldEl.querySelector('input[data-range-end="low"]');
          var hi = fieldEl.querySelector('input[data-range-end="high"]');
          if (lo && hi) values[name] = [parseFloat(lo.value), parseFloat(hi.value)];
          break;
        }
        case 'checkbox':
        case 'toggle': {
          var cb = fieldEl.querySelector('input[type="checkbox"]');
          if (cb) values[name] = cb.checked;
          break;
        }
        case 'radio': {
          var selected = fieldEl.querySelector('input[type="radio"]:checked');
          values[name] = selected ? selected.value : null;
          break;
        }
        case 'text': {
          var txt = fieldEl.querySelector('input[type="text"]');
          if (txt) values[name] = txt.value;
          break;
        }
        case 'date_range': {
          var s = fieldEl.querySelector('input[data-range-end="start"]');
          var e = fieldEl.querySelector('input[data-range-end="end"]');
          if (s && e) values[name] = [s.value, e.value];
          break;
        }
        case 'number': {
          var num = fieldEl.querySelector('input[type="number"]');
          if (num) values[name] = num.value !== '' ? parseFloat(num.value) : null;
          break;
        }
      }
    });
    return values;
  }

  function renderFrozenForm(container, values, fields) {
    var frozen = document.createElement('div');
    frozen.className = 'form-frozen';

    // Build a map of field names to labels
    var labelMap = {};
    (fields || []).forEach(function(f) {
      labelMap[f.name] = f.label || f.name;
    });

    Object.keys(values).forEach(function(key) {
      var val = values[key];
      var item = document.createElement('span');
      item.className = 'form-frozen-item';

      var labelSpan = document.createElement('span');
      labelSpan.className = 'frozen-label';
      labelSpan.textContent = (labelMap[key] || key) + ':';
      item.appendChild(labelSpan);

      var valueSpan = document.createElement('span');
      valueSpan.className = 'frozen-value';
      if (typeof val === 'boolean') {
        valueSpan.textContent = val ? 'yes' : 'no';
      } else if (Array.isArray(val)) {
        valueSpan.textContent = val.join(' \u2013 ');
      } else {
        valueSpan.textContent = String(val);
      }
      item.appendChild(valueSpan);
      frozen.appendChild(item);
    });

    container.appendChild(frozen);
  }

  // ================================================================
  // RESPONSE UI — confirm/skip, countdown, sendResponse
  // ================================================================
  function buildResponseUI(cardData, cardEl) {
    var container = document.createElement('div');
    container.className = 'card-response-ui';

    // Prompt
    if (cardData.prompt) {
      var promptEl = document.createElement('div');
      promptEl.className = 'response-prompt';
      promptEl.textContent = cardData.prompt;
      container.appendChild(promptEl);
    }

    // Message input
    var msgInput = document.createElement('textarea');
    msgInput.className = 'response-message-input';
    msgInput.placeholder = 'Optional message...';
    msgInput.rows = 1;
    container.appendChild(msgInput);

    // Actions
    var actionsRow = document.createElement('div');
    actionsRow.className = 'response-actions';

    // Quick actions: if cardData.actions is a non-empty array, render action buttons
    // instead of the default Confirm button
    if (cardData.actions && Array.isArray(cardData.actions) && cardData.actions.length > 0) {
      cardData.actions.forEach(function(actionName) {
        var actionBtn = document.createElement('button');
        actionBtn.className = 'response-btn response-btn-action';
        actionBtn.textContent = actionName;
        actionBtn.onclick = function() {
          sendResponse(cardData, cardEl, actionName, msgInput.value);
        };
        actionsRow.appendChild(actionBtn);
      });
    } else {
      var confirmBtn = document.createElement('button');
      confirmBtn.className = 'response-btn response-btn-confirm';
      confirmBtn.textContent = 'Confirm';
      confirmBtn.onclick = function() {
        sendResponse(cardData, cardEl, 'confirm', msgInput.value);
      };
      actionsRow.appendChild(confirmBtn);
    }

    var skipBtn = document.createElement('button');
    skipBtn.className = 'response-btn response-btn-skip';
    skipBtn.textContent = 'Skip';
    skipBtn.onclick = function() {
      sendResponse(cardData, cardEl, 'skip', null);
    };
    actionsRow.appendChild(skipBtn);

    // Timeout countdown
    var timeoutEl = document.createElement('span');
    timeoutEl.className = 'response-timeout';
    actionsRow.appendChild(timeoutEl);
    container.appendChild(actionsRow);

    // Start countdown (use backend-configured timeout, default 5 min)
    var remaining = (cardData.timeout && cardData.timeout > 0) ? Math.floor(cardData.timeout) : 300;
    function updateCountdown() {
      var mins = Math.floor(remaining / 60);
      var secs = remaining % 60;
      timeoutEl.textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;
      if (remaining <= 0) {
        clearInterval(timer);
        timeoutEl.textContent = 'Timed out';
        return;
      }
      remaining--;
    }
    updateCountdown();
    var timer = setInterval(updateCountdown, 1000);
    container._timer = timer;

    return container;
  }

  function sendResponse(cardData, cardEl, action, message) {
    // Gather selected indices from selection state
    var selectedRows = null;
    var columns = null;
    var selectedIndices = null;
    var sel = state.selections[cardData.card_id];
    if (cardData.card_type === 'table' && sel && sel.size > 0) {
      columns = cardData.preview.columns;
      selectedIndices = Array.from(sel).sort(function(a, b) { return a - b; });
      // Also gather currently visible checked rows for backward compat
      var tbody = cardEl.querySelector('tbody');
      if (tbody) {
        var checkboxes = tbody.querySelectorAll('input[type="checkbox"]:checked');
        if (checkboxes.length > 0) {
          selectedRows = [];
          checkboxes.forEach(function(cb) {
            var tr = cb.closest('tr');
            var cells = [];
            tr.querySelectorAll('td:not(.select-col)').forEach(function(td) {
              cells.push(td.textContent === '\u2014' ? null : td.textContent);
            });
            selectedRows.push(cells);
          });
        }
      }
    }

    // Collect form values from form card body or controls bar
    var formValues = {};
    var hasFormFields = cardEl.querySelector('.form-field');
    if (hasFormFields) {
      formValues = collectFormValues(cardEl);
    }

    // Send via WebSocket
    if (state.ws && state.connected) {
      state.ws.send(JSON.stringify({
        type: 'vitrine.event',
        event_type: 'response',
        card_id: cardData.card_id,
        payload: {
          action: action,
          message: message,
          selected_rows: selectedRows,
          selected_indices: selectedIndices,
          columns: columns,
          form_values: formValues,
        },
      }));
    }

    // Update UI: remove response panel, remove waiting style
    var responseUI = cardEl.querySelector('.card-response-ui');
    if (responseUI) {
      if (responseUI._timer) clearInterval(responseUI._timer);
      responseUI.remove();
    }
    cardEl.classList.remove('waiting');
    var headerEl = cardEl.querySelector('.card-header');
    if (headerEl) {
      headerEl.setAttribute('data-type', cardData.card_type);
      var iconEl = headerEl.querySelector('.card-type-icon');
      if (iconEl) {
        iconEl.setAttribute('data-type', cardData.card_type);
        iconEl.textContent = TYPE_LETTERS[cardData.card_type] || '?';
      }
    }
    // Clear agent status
    updateAgentStatus('');

    // Freeze form: replace interactive fields with compact frozen display
    if (action === 'confirm' && hasFormFields && Object.keys(formValues).length > 0) {
      var formBody = cardEl.querySelector('.card-body');
      var controlsBar = cardEl.querySelector('.card-controls-bar');
      var fields = (cardData.preview && cardData.preview.fields) || (cardData.preview && cardData.preview.controls) || [];
      if (cardData.card_type === 'form' && formBody) {
        formBody.innerHTML = '';
        renderFrozenForm(formBody, formValues, fields);
      }
      if (controlsBar) {
        controlsBar.innerHTML = '';
        renderFrozenForm(controlsBar, formValues, fields);
      }
    }

    // Show confirmation badge
    var badge = document.createElement('span');
    badge.className = 'sent-badge';
    badge.textContent = action === 'confirm' ? 'Confirmed' : 'Skipped';
    var header = cardEl.querySelector('.card-header');
    if (header) header.appendChild(badge);
  }

  // ================================================================
  // SECTIONS, CARD UPDATES & RUN FILTERING
  // ================================================================
  function addSection(title, runId) {
    var empty = document.getElementById('empty-state');
    if (empty && empty.parentNode) {
      empty.remove();
    }

    if (runId) trackRunId(runId);

    var div = document.createElement('div');
    div.className = 'section-divider';
    div.textContent = title;
    div.dataset.runId = runId || '';
    feed.appendChild(div);

    if (state.activeRunFilter) {
      applyRunFilter();
    }

    scrollToBottom();
  }

  function updateCard(cardId, newCardData) {
    var el = document.getElementById('card-' + cardId);
    if (!el) return;

    // Update state.cards entry
    if (newCardData) {
      for (var i = 0; i < state.cards.length; i++) {
        if (state.cards[i].card_id === cardId) {
          state.cards[i] = newCardData;
          break;
        }
      }

      // Update title
      var titleEl = el.querySelector('.card-title');
      if (titleEl) {
        titleEl.textContent = newCardData.title || newCardData.card_type;
      }

      var header = el.querySelector('.card-header');
      if (header) {
        var headerType = newCardData.response_requested ? 'decision' : newCardData.card_type;
        header.setAttribute('data-type', headerType);
        var typeIcon = header.querySelector('.card-type-icon');
        if (typeIcon) {
          typeIcon.setAttribute('data-type', headerType);
          typeIcon.textContent = TYPE_LETTERS[headerType] || '?';
        }
      }

      // Re-render body content
      var body = el.querySelector('.card-body');
      if (body) {
        body.innerHTML = '';
        switch (newCardData.card_type) {
          case 'table':
            renderTable(body, newCardData);
            break;
          case 'plotly':
            renderPlotly(body, newCardData);
            break;
          case 'image':
            renderImage(body, newCardData);
            break;
          case 'markdown':
            renderMarkdown(body, newCardData);
            break;
          case 'keyvalue':
            renderKeyValue(body, newCardData);
            break;
          case 'form':
            renderForm(body, newCardData);
            break;
          default:
            body.textContent = JSON.stringify(newCardData.preview);
        }
      }
    }

    // Flash animation to highlight the update
    el.classList.remove('flash');
    void el.offsetWidth; // Force reflow
    el.classList.add('flash');
    setTimeout(function() { el.classList.remove('flash'); }, 600);
  }

  function rebuildRunFilter() {
    // Rebuild runIds from cards (used as fallback)
    var runs = [];
    state.cards.forEach(function(c) {
      if (c.run_id && runs.indexOf(c.run_id) === -1) runs.push(c.run_id);
    });
    state.runIds = runs;

    // If the current filter no longer exists, switch to "All runs"
    if (state.activeRunFilter && runs.indexOf(state.activeRunFilter) === -1) {
      state.activeRunFilter = '';
      updateDropdownTrigger();
    }
  }

  function showEmptyState() {
    var existing = document.getElementById('empty-state');
    if (existing) return;

    var empty = document.createElement('div');
    empty.className = 'empty-state';
    empty.id = 'empty-state';
    empty.innerHTML = '<div style="font-size: 32px; opacity: 0.3;">&#9671;</div>'
      + '<div style="font-size: 15px; font-weight: 500;">No analyses yet</div>'
      + '<div style="font-size: 13px;">Run an agent to get started</div>'
      + '<div><code>from m4.vitrine import show</code></div>';
    feed.appendChild(empty);
  }

  // ================================================================
  // UI HELPERS — status, card count, session info, scroll
  // ================================================================
  function updateStatus(status) {
    var dotClass = status === 'connected' ? 'status-connected'
      : status === 'disconnected' ? 'status-disconnected'
      : 'status-connecting';
    var label = status.charAt(0).toUpperCase() + status.slice(1);
    statusEl.innerHTML = '<span class="status-dot ' + dotClass + '"></span> ' + label;
  }

  function updateCardCount() {
    var all = feed.querySelectorAll('.card');
    var visible = 0;
    all.forEach(function(el) {
      if (!el.classList.contains('hidden-by-filter')) visible++;
    });
    var text = visible + ' card' + (visible !== 1 ? 's' : '');
    if (visible !== all.length) {
      text += ' (of ' + all.length + ')';
    }
    cardCountEl.textContent = text;

    // Footer: show run label or run count
    if (state.activeRunFilter) {
      var run = null;
      for (var i = 0; i < state.runs.length; i++) {
        if (state.runs[i].label === state.activeRunFilter) { run = state.runs[i]; break; }
      }
      if (run && run.start_time) {
        sessionInfoEl.textContent = state.activeRunFilter + ' \u00b7 ' + dateGroupLabel(run.start_time);
      } else {
        sessionInfoEl.textContent = state.activeRunFilter;
      }
    } else {
      var totalRuns = state.runs.length;
      sessionInfoEl.textContent = totalRuns > 0 ? totalRuns + ' run' + (totalRuns !== 1 ? 's' : '') : '';
    }
  }

  function loadSessionInfo() {
    fetch('/api/session')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var sid = (data.session_id || '').substring(0, 8);
        sessionInfoEl.textContent = sid ? 'session: ' + sid : '';
      })
      .catch(function() {});
  }

  function loadRuns() {
    fetch('/api/runs')
      .then(function(r) { return r.json(); })
      .then(function(runs) {
        if (!Array.isArray(runs)) return;
        state.runs = runs;
        state.runIds = [];
        runs.forEach(function(run) {
          var label = run.label || run.dir_name || '';
          if (label && state.runIds.indexOf(label) === -1) state.runIds.push(label);
        });

        // Validate current filter still exists
        if (state.activeRunFilter && state.runIds.indexOf(state.activeRunFilter) === -1) {
          state.activeRunFilter = '';
          updateDropdownTrigger();
        }

        // Auto-select most recent run on first load
        if (!state.liveMode && !state.activeRunFilter && runs.length > 0) {
          state.activeRunFilter = runs[0].label;
          updateDropdownTrigger();
          applyRunFilter();
          updateRunMetadataBar();
        }

        updateCardCount();

        // Update empty state
        if (runs.length === 0 && state.cards.length === 0) {
          showEmptyState();
        }
      })
      .catch(function() {});
  }

  function scrollToBottom() {
    requestAnimationFrame(function() {
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    });
  }

  // ================================================================
  // AGENT STATUS & BROWSER NOTIFICATIONS
  // ================================================================
  var agentStatusEl = document.getElementById('agent-status');

  function updateAgentStatus(text) {
    if (agentStatusEl) agentStatusEl.textContent = text;
  }

  function notifyDecisionCard(cardData) {
    if (!document.hidden) return;
    if (!('Notification' in window)) return;
    if (Notification.permission === 'granted') {
      var title = cardData.title || 'Decision needed';
      var body = cardData.prompt || 'A card is waiting for your response.';
      new Notification(title, { body: body, icon: '/static/favicon.ico' });
    } else if (Notification.permission !== 'denied') {
      Notification.requestPermission().then(function(perm) {
        if (perm === 'granted') {
          var title = cardData.title || 'Decision needed';
          var body = cardData.prompt || 'A card is waiting for your response.';
          new Notification(title, { body: body, icon: '/static/favicon.ico' });
        }
      });
    }
  }

  // ================================================================
  // DEEP-LINK URLs
  // ================================================================
  function parseHashRun() {
    var hash = location.hash || '';
    var m = hash.match(/^#run=(.+)$/);
    return m ? decodeURIComponent(m[1]) : null;
  }

  function applyHashRun() {
    var label = parseHashRun();
    if (label) {
      // Check if this run exists
      var exists = state.runs.some(function(r) { return r.label === label; }) ||
                   state.runIds.indexOf(label) !== -1;
      if (exists && state.activeRunFilter !== label) {
        selectRun(label);
      }
    }
  }

  window.addEventListener('hashchange', function() {
    applyHashRun();
  });

  // Patch selectRun to update hash
  var _origSelectRun = selectRun;
  selectRun = function(label) {
    _origSelectRun(label);
    if (label) {
      history.replaceState(null, '', '#run=' + encodeURIComponent(label));
    } else {
      history.replaceState(null, '', location.pathname + location.search);
    }
  };

  // ================================================================
  // INIT
  // ================================================================
  var _origLoadRuns = loadRuns;
  loadRuns = function() {
    _origLoadRuns();
    // After runs load, check for deep link
    setTimeout(function() { applyHashRun(); }, 600);
  };

  connect();
})();
</script>
</body>
</html>
